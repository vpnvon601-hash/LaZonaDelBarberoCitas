<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA ZONA DEL BARBERO | Agenda tu Cita</title>
    <!-- Carga de Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Fuentes y Estilos -->
    <style>
        /* Usando Inter como fuente principal */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Fondo gris oscuro/negro */
            color: #f3f4f6; /* Texto blanco/gris claro */
        }
        .card {
            background-color: #2c2c2c; /* Fondo de tarjeta gris oscuro */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            border: 1px solid #4a4a4a; /* Borde sutil */
        }
        .btn-primary {
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #5a5a5a;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #4a4a4a;
            border-color: #ffffff;
        }
        .input-style, select {
            background-color: #1a1a1a;
            color: #f3f4f6;
            border-color: #5a5a5a;
        }
        /* Estilo para el calendario (fecha) */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Hace que el icono de calendario se vea blanco */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="card w-full max-w-xl rounded-xl p-6 md:p-10">
        <h1 class="text-4xl font-bold text-center mb-2 tracking-wider text-white">LA ZONA DEL BARBERO</h1>
        <p class="text-center text-gray-400 mb-8">Agenda tu Próxima Cita con Estilo</p>

        <form id="bookingForm" class="space-y-6">
            <!-- Sección de Datos del Cliente -->
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-gray-200">1. Tus Datos</h2>
            
            <div>
                <label for="nombre" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label>
                <input type="text" id="nombre" name="nombre" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>
            <div>
                <label for="apellido" class="block text-sm font-medium text-gray-300 mb-1">Apellido</label>
                <input type="text" id="apellido" name="apellido" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>
            <div>
                <label for="telefono" class="block text-sm font-medium text-gray-300 mb-1">Número de Teléfono (Ej: 3233489369)</label>
                <input type="tel" id="telefono" name="telefono" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" pattern="[0-9]{10}" title="Debe contener 10 dígitos numéricos." required>
            </div>
            <div>
                <label for="correo" class="block text-sm font-medium text-gray-300 mb-1">Correo Electrónico</label>
                <input type="email" id="correo" name="correo" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>

            <!-- Sección de Barbero y Servicio -->
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 pt-4 text-gray-200">2. Barbero y Servicio</h2>

            <div>
                <label for="barbero" class="block text-sm font-medium text-gray-300 mb-1">Barbero</label>
                <select id="barbero" name="barbero" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500 appearance-none" required>
                    <option value="" disabled selected>Selecciona un Barbero</option>
                    <!-- Opciones de barberos cargadas en JS -->
                </select>
            </div>

            <div>
                <label for="servicio" class="block text-sm font-medium text-gray-300 mb-1">Servicio</label>
                <select id="servicio" name="servicio" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500 appearance-none" required>
                    <option value="" disabled selected>Selecciona un Servicio</option>
                    <!-- Opciones de servicios cargadas en JS -->
                </select>
            </div>

            <div id="precio-display" class="text-lg font-bold text-center text-gray-200 mt-4 mb-4 hidden">
                Precio: <span id="precio-valor" class="text-white"></span>
            </div>

            <!-- Sección de Fecha y Hora -->
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 pt-4 text-gray-200">3. Programar Fecha y Hora</h2>

            <div>
                <label for="fecha" class="block text-sm font-medium text-gray-300 mb-1">Programar Fecha</label>
                <input type="date" id="fecha" name="fecha" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>

            <div>
                <label for="hora" class="block text-sm font-medium text-gray-300 mb-1">Programar Hora</label>
                <select id="hora" name="hora" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500 appearance-none" required disabled>
                    <option value="" disabled selected>Selecciona un Barbero y Servicio</option>
                </select>
                <p id="loading-message" class="text-sm text-gray-400 mt-2 hidden">Cargando disponibilidad...</p>
            </div>

            <!-- Mensajes del sistema -->
            <div id="message-box" class="p-3 mt-4 rounded-lg text-center font-medium hidden"></div>

            <button type="submit" id="submit-btn" class="btn-primary w-full p-3 rounded-lg text-lg font-semibold hover:bg-gray-700 transition duration-150 ease-in-out" disabled>
                Confirmar Cita y Notificar
            </button>
        </form>
    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('debug'); // Usar solo para depuración si es necesario

        // --- Configuración de Entorno (Usando la configuración del usuario) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
            authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
            projectId: "lazonadelbarbero-b4e75",
            storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
            messagingSenderId: "251180096928",
            appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
            measurementId: "G-G4YL7M4Z00"
        };
        
        // Usar el projectId como ID de aplicación si no se define la variable de entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Número de WhatsApp al que se enviará la confirmación
        const WA_PHONE_NUMBER = '573233489369';
        
        // --- Constantes de la Aplicación ---
        const SERVICES = [
            { id: 'corte', name: 'Corte', price: 18000, duration: 30 },
            { id: 'corte_ceja', name: 'Corte + Ceja', price: 22000, duration: 40 },
            { id: 'corte_ceja_barba', name: 'Corte + Ceja + Barba', price: 25000, duration: 60 }, // 1 hora
            { id: 'corte_limpieza', name: 'Corte + Limpieza Facial', price: 65000, duration: 150 } // 2.5 horas
        ];

        // --- LISTA DE BARBEROS (Actualizada) ---
        const BARBERS = [
            { id: 'dylan', name: 'Dylan' },
            { id: 'santiago', name: 'Santiago' },
            { id: 'alejandro', name: 'Alejandro' },
            { id: 'leo', name: 'Leo' },
        ];
        // ----------------------------------------

        const OPEN_TIME = 10 * 60; // 10:00 AM en minutos desde medianoche
        const CLOSE_TIME = (20 * 60) + 40; // 8:40 PM en minutos desde medianoche

        // --- Variables de Estado y Elementos del DOM ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let activeSnapshotUnsubscribe = null;
        let bookedAppointments = [];

        const form = document.getElementById('bookingForm');
        const barberoSelect = document.getElementById('barbero');
        const servicioSelect = document.getElementById('servicio');
        const fechaInput = document.getElementById('fecha');
        const horaSelect = document.getElementById('hora');
        const submitBtn = document.getElementById('submit-btn');
        const messageBox = document.getElementById('message-box');
        const loadingMessage = document.getElementById('loading-message');
        const precioValor = document.getElementById('precio-valor');
        const precioDisplay = document.getElementById('precio-display');
        
        // --- Funciones de Utilidad ---

        /**
         * Formatea un número como moneda colombiana (COP).
         * @param {number} value El valor a formatear.
         * @returns {string} El valor formateado.
         */
        const formatCOP = (value) => {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        };

        /**
         * Convierte un número de minutos (desde medianoche) a formato HH:MM (24h).
         * @param {number} totalMinutes Minutos totales.
         * @returns {string} Hora en formato HH:MM.
         */
        const minutesToTime = (totalMinutes) => {
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };

        /**
         * Muestra un mensaje en la interfaz.
         * @param {string} message El mensaje a mostrar.
         * @param {string} type Tipo de mensaje ('success', 'error', 'info').
         */
        const displayMessage = (message, type) => {
            messageBox.textContent = message;
            messageBox.className = 'p-3 mt-4 rounded-lg text-center font-medium';
            messageBox.classList.remove('hidden');
            
            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-700', 'text-white');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-700', 'text-white');
                    break;
                default:
                    messageBox.classList.add('bg-gray-700', 'text-gray-100');
            }
        };

        /**
         * Valida si un bloque de tiempo (startMin, duration) está disponible.
         * @param {number} startMin Minuto de inicio de la cita propuesta.
         * @param {number} duration Duración de la cita propuesta.
         * @returns {boolean} True si está disponible, False si hay solapamiento.
         */
        const isSlotAvailable = (startMin, duration) => {
            const endMin = startMin + duration;

            // 1. Verificar si está dentro del horario de cierre (8:40 PM)
            if (endMin > CLOSE_TIME) {
                return false;
            }

            // 2. Verificar solapamiento con citas agendadas
            for (const appointment of bookedAppointments) {
                const bookedStart = appointment.startMinutes;
                const bookedEnd = appointment.endMinutes;

                // Criterios de solapamiento:
                // La nueva cita empieza antes de que termine la agendada Y termina después de que empiece la agendada.
                const overlaps = (startMin < bookedEnd && endMin > bookedStart);
                
                if (overlaps) {
                    console.log(`Solapamiento detectado: Propuesta ${minutesToTime(startMin)}-${minutesToTime(endMin)} vs Agendada ${minutesToTime(bookedStart)}-${minutesToTime(bookedEnd)}`);
                    return false; // Slot ocupado
                }
            }
            return true; // Slot disponible
        };

        /**
         * Genera la lista de horas disponibles basada en las citas agendadas.
         */
        const generateTimeSlots = () => {
            horaSelect.innerHTML = '<option value="" disabled selected>Selecciona una Hora</option>';
            horaSelect.disabled = true;
            submitBtn.disabled = true;

            const selectedServiceId = servicioSelect.value;
            const selectedService = SERVICES.find(s => s.id === selectedServiceId);

            if (!selectedService || !bookedAppointments) {
                return;
            }

            const duration = selectedService.duration;
            const availableSlots = [];

            // Iterar desde la hora de apertura (10:00 AM)
            // Se itera cada 10 minutos para la selección de hora
            for (let startMin = OPEN_TIME; startMin < CLOSE_TIME; startMin += 10) {
                
                if (isSlotAvailable(startMin, duration)) {
                    const timeString = minutesToTime(startMin);
                    
                    // Asegurarse de que el inicio de la cita no esté demasiado cerca del cierre
                    if (startMin + duration <= CLOSE_TIME) {
                        availableSlots.push({ 
                            time: timeString, 
                            startMinutes: startMin, 
                            endMinutes: startMin + duration 
                        });
                    }
                }
            }

            if (availableSlots.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No hay horas disponibles para este servicio/día.';
                option.disabled = true;
                horaSelect.appendChild(option);
            } else {
                availableSlots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.time;
                    option.textContent = `${slot.time} - (Finaliza ${minutesToTime(slot.endMinutes)})`;
                    horaSelect.appendChild(option);
                });
                horaSelect.disabled = false;
            }
        };

        // --- Lógica de Firebase y Carga de Datos ---
        
        /**
         * Path a la colección de citas para el Barbero y Fecha seleccionados.
         * @param {string} barberId ID del barbero.
         * @param {string} dateString Fecha en formato YYYY-MM-DD.
         * @returns {string} Ruta de la colección.
         */
        const getAppointmentsCollectionPath = (barberId, dateString) => {
            // Ruta pública para que todos puedan ver la disponibilidad
            return `artifacts/${appId}/public/data/barber_appointments/${barberId}/${dateString}`;
        };

        /**
         * Inicia el listener de Firestore para la disponibilidad del barbero/fecha seleccionados.
         */
        const startAvailabilityListener = () => {
            // Se debe verificar que la base de datos esté lista antes de consultar
            if (!isAuthReady || !db) return;

            // Limpiar listener anterior si existe
            if (activeSnapshotUnsubscribe) {
                activeSnapshotUnsubscribe();
                activeSnapshotUnsubscribe = null;
            }

            const barberId = barberoSelect.value;
            const dateString = fechaInput.value;

            if (!barberId || !dateString) {
                bookedAppointments = [];
                generateTimeSlots();
                return;
            }

            loadingMessage.classList.remove('hidden');
            horaSelect.disabled = true;

            const collectionPath = getAppointmentsCollectionPath(barberId, dateString);
            const q = collection(db, collectionPath);
            
            // onSnapshot es crucial para la reactividad en tiempo real
            activeSnapshotUnsubscribe = onSnapshot(q, (snapshot) => {
                bookedAppointments = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    bookedAppointments.push({
                        id: doc.id,
                        startMinutes: data.startMinutes,
                        endMinutes: data.endMinutes,
                        duration: data.duration,
                        serviceId: data.serviceId
                    });
                });

                // Ordenar por hora de inicio
                bookedAppointments.sort((a, b) => a.startMinutes - b.startMinutes);
                
                loadingMessage.classList.add('hidden');
                generateTimeSlots();

            }, (error) => {
                console.error("Error de Firestore al obtener las citas (Revisa Reglas de Seguridad):", error);
                loadingMessage.classList.add('hidden');
                displayMessage("Error al cargar la disponibilidad. Posiblemente un problema con las Reglas de Seguridad.", 'error');
            });
        };

        /**
         * Inicializa la app de Firebase y la autenticación.
         */
        const initializeFirebase = async () => {
            try {
                // 1. Inicializar App
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 2. Autenticación (esperar resolución)
                const authReadyPromise = new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); 
                        try {
                            if (!user) {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                            isAuthReady = true;
                            resolve();
                        } catch (authError) {
                            console.error("Error durante el inicio de sesión de Firebase:", authError);
                            displayMessage("Error fatal: No se pudo iniciar sesión. Revisa las credenciales o reglas de Auth.", 'error');
                            reject(authError);
                        }
                    }, (error) => {
                        reject(error);
                    });
                });

                await authReadyPromise;
                
                // 3. Cargar datos si la autenticación fue exitosa
                loadStaticOptions();
                
            } catch (error) {
                console.error("Error CRÍTICO en la inicialización (Configuración Inválida):", error);
                displayMessage("Error fatal: No se pudo conectar a la base de datos. Revisa la consola y tu archivo de configuración.", 'error');
            }
        };

        // --- Carga y Gestión de Opciones Estáticas ---

        const loadStaticOptions = () => {
            // 1. Cargar Barberos
            BARBERS.forEach(barber => {
                const option = document.createElement('option');
                option.value = barber.id;
                option.textContent = barber.name;
                barberoSelect.appendChild(option);
            });

            // 2. Cargar Servicios
            SERVICES.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name} (${formatCOP(service.price)})`;
                servicioSelect.appendChild(option);
            });

            // 3. Establecer fecha mínima para el calendario (hoy)
            const today = new Date().toISOString().split('T')[0];
            fechaInput.min = today;
            
            displayMessage("Sistema de Agendamiento listo.", 'info');
        };

        // --- Handlers de Eventos ---
        
        const handleFormChange = (event) => {
            // Activar el botón de envío solo si todos los campos requeridos están llenos y se ha seleccionado una hora
            submitBtn.disabled = !form.checkValidity() || horaSelect.value === '';
            
            // Actualizar disponibilidad cuando cambian Barbero, Servicio o Fecha
            if (event.target === barberoSelect || event.target === servicioSelect || event.target === fechaInput) {
                // Si el Barbero, Servicio, o Fecha han sido seleccionados, iniciar el listener
                if (barberoSelect.value && servicioSelect.value && fechaInput.value) {
                    startAvailabilityListener();
                } else {
                    // Si falta alguno, limpiar el listener y los slots.
                    if (activeSnapshotUnsubscribe) {
                        activeSnapshotUnsubscribe();
                        activeSnapshotUnsubscribe = null;
                    }
                    bookedAppointments = [];
                    generateTimeSlots();
                }
            }
            
            // Mostrar precio cuando se selecciona un servicio
            if (event.target === servicioSelect) {
                const selectedService = SERVICES.find(s => s.id === servicioSelect.value);
                if (selectedService) {
                    precioValor.textContent = formatCOP(selectedService.price);
                    precioDisplay.classList.remove('hidden');
                } else {
                    precioDisplay.classList.add('hidden');
                }
            }
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                displayMessage("El sistema aún se está inicializando. Por favor, espera un momento.", 'info');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Agendando...';

            // 1. Recoger datos del formulario
            const data = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                telefono: document.getElementById('telefono').value,
                correo: document.getElementById('correo').value,
                barberoId: barberoSelect.value,
                barberoName: barberoSelect.options[barberoSelect.selectedIndex].text,
                servicioId: servicioSelect.value,
                // Quitar el precio del nombre del servicio para el mensaje
                servicioName: servicioSelect.options[servicioSelect.selectedIndex].text.split('(')[0].trim(), 
                fecha: fechaInput.value,
                hora: horaSelect.value,
                timestamp: Timestamp.now(),
                userId: userId // ID del usuario que crea la cita
            };
            
            const selectedService = SERVICES.find(s => s.id === data.servicioId);
            const [h, m] = data.hora.split(':').map(Number);
            const startMinutes = (h * 60) + m;
            const endMinutes = startMinutes + selectedService.duration;
            const servicePrice = formatCOP(selectedService.price);

            // 2. Crear objeto de cita para Firestore
            const appointmentData = {
                ...data,
                startMinutes: startMinutes,
                endMinutes: endMinutes,
                duration: selectedService.duration,
                price: selectedService.price,
                verification: 'pending' 
            };

            // 3. Guardar en Firestore
            try {
                const collectionPath = getAppointmentsCollectionPath(data.barberoId, data.fecha);
                const docRef = await addDoc(collection(db, collectionPath), appointmentData);
                
                displayMessage(`Cita agendada exitosamente (ID: ${docRef.id}). Redirigiendo a WhatsApp...`, 'success');

                // 4. Construir y enviar mensaje de WhatsApp
                const mensaje = `
*Cita Agendada en LA ZONA DEL BARBERO*
Hola, mi nombre es ${data.nombre} ${data.apellido}.

*Detalles de la Cita:*
Barbero: ${data.barberoName}
Servicio: ${data.servicioName}
Costo: ${servicePrice}
Fecha: ${data.fecha}
Hora: ${data.hora}
Duración Estimada: ${selectedService.duration} minutos

*Contacto del Cliente:*
Teléfono: ${data.telefono}
Correo: ${data.correo}

Por favor, confirmar disponibilidad y guardar la cita. ¡Gracias!
                `.trim();

                const encodedMessage = encodeURIComponent(mensaje);
                const waUrl = `https://api.whatsapp.com/send?phone=${WA_PHONE_NUMBER}&text=${encodedMessage}`;
                
                // Redirigir al usuario
                setTimeout(() => {
                    window.open(waUrl, '_blank');
                    submitBtn.textContent = 'Cita Confirmada';
                    // Reiniciar el formulario después de la redirección
                    form.reset();
                }, 1500); 

            } catch (error) {
                console.error("Error al guardar la cita en Firestore (Revisa Reglas de Seguridad):", error);
                displayMessage("Hubo un error al agendar tu cita. Posiblemente un problema de permisos.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirmar Cita y Notificar';
            }
        };

        // --- Inicialización ---
        window.onload = () => {
            initializeFirebase();
            form.addEventListener('change', handleFormChange);
            form.addEventListener('input', handleFormChange);
            form.addEventListener('submit', handleSubmit);
            
            // Inicializar disponibilidad mínima al día de hoy
            const today = new Date().toISOString().split('T')[0];
            fechaInput.value = today;
        };

    </script>
</body>
</html>

