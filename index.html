<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LA ZONA DEL BARBERO ‚Äî Agendamiento</title>

  <!-- Tipograf√≠a: usa la sistem font de iOS / fallback -->
  <style>
    :root{
      --bg:#0b0b0d;
      --card:rgba(255,255,255,0.04);
      --glass:rgba(255,255,255,0.06);
      --muted:rgba(255,255,255,0.62);
      --text:#ffffff;
      --accent:#0ea5e9;
      --success:#34d399;
      --danger:#fb7185;
      --radius:18px;
      --shadow: 0 8px 30px rgba(2,6,23,0.6);
      --glass-blur: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #06060a 0%, #08111a 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
    }

    .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:22px}
    @media(max-width:980px){ .container{grid-template-columns:1fr;padding:14px} }

    /* Header simple */
    .brand{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:10px}
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg,#f6c358,#7be3a8);
      display:grid;place-items:center;color:#031014;font-weight:900;font-size:18px;
      box-shadow:0 8px 22px rgba(0,0,0,0.6);
    }
    .brand h1{font-size:20px;margin:0}

    /* Cards iOS */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      padding:20px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--glass-blur));
    }

    h2{margin:0 0 12px 0;font-size:20px;letter-spacing:-0.2px}
    .muted{color:var(--muted);font-size:13px}

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:none;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:var(--text);
      font-size:15px;
      margin-bottom:12px;
      outline: none;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.02);
      transition: box-shadow .18s, transform .12s;
    }
    input::placeholder{color:rgba(255,255,255,0.35)}
    input:focus, select:focus { box-shadow: 0 8px 30px rgba(14,165,233,0.12); transform: translateY(-1px); }

    /* iOS buttons */
    .btn{
      display:inline-flex;align-items:center;gap:8px;justify-content:center;
      padding:12px 16px;border-radius:14px;border:none;font-weight:700;cursor:pointer;
    }
    .btn-primary{background:linear-gradient(90deg,var(--accent), #6ee7f5);color:#021018}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    /* Stepper (small pill) */
    .stepper{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .step{width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.02);display:grid;place-items:center;font-weight:700;border:1px solid rgba(255,255,255,0.03)}
    .step.active{background:linear-gradient(90deg,var(--accent), #6ee7f5);color:#021018;box-shadow:0 8px 24px rgba(14,165,233,0.12);}

    /* Tabs/panels */
    .tabs{position:relative;overflow:hidden;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.02);margin-bottom:12px}
    .tab-panels{display:flex;transition:transform .36s cubic-bezier(.2,.9,.2,1)}
    .tab-panel{min-width:100%;padding:4px}

    /* Availability list */
    .available-list{
      background: rgba(255,255,255,0.02);
      border-radius:12px;padding:10px;max-height:300px;overflow:auto;border:1px solid rgba(255,255,255,0.02);
    }
    .slot{
      display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;margin-bottom:10px;cursor:pointer;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.02);
      transition:transform .12s, box-shadow .12s;
    }
    .slot:hover{transform:translateY(-4px);box-shadow:0 10px 22px rgba(2,6,23,0.6)}
    .slot.busy{background:transparent;color:var(--danger);opacity:0.95;cursor:not-allowed;border:1px solid rgba(251,113,133,0.06)}
    .slot.selected{background:linear-gradient(90deg,var(--accent), #6ee7f5);color:#021018;font-weight:800;box-shadow:0 10px 28px rgba(14,165,233,0.12)}

    /* Summary right */
    .summary-card{position:sticky;top:36px}

    .res-box{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);margin-top:12px}

    /* Toast container */
    .toast-container{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:99999}
    .toast{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:12px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04);min-width:220px;color:var(--text);font-weight:600;opacity:0;transform:translateY(10px);animation:toast-in .28s forwards}
    .toast.success{border-left:4px solid var(--success)}
    .toast.error{border-left:4px solid var(--danger)}
    @keyframes toast-in{to{opacity:1;transform:translateY(0);} }

    /* Splash */
    .splash{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,#05060a 0%, #07141f 100%);z-index:9998}
    .splash .card{width:320px;text-align:center;padding:26px}
    .splash .logo{width:84px;height:84px;border-radius:18px;margin:0 auto;display:grid;place-items:center;background:linear-gradient(135deg,#f6c358,#7be3a8);font-weight:900;color:#031018;font-size:28px;box-shadow:0 12px 40px rgba(2,6,23,0.6)}

    /* misc */
    .meta{font-size:12px;color:var(--muted);margin-top:8px}
    .loader{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:680px){ .container{grid-template-columns:1fr} .splash .card{width:88vw} }
  </style>
</head>
<body>

  <!-- SPLASH -->
  <div id="splash" class="splash" aria-hidden="false">
    <div class="card">
      <div class="logo">LB</div>
      <h3 style="margin:14px 0 6px 0">Agenda Citas</h3>
      <p class="muted" style="margin:0">LA ZONA DEL BARBERO ‚Äî Preparando tu experiencia</p>
      <div style="height:12px"></div>
      <div class="loader" style="margin:0 auto"></div>
    </div>
  </div>

  <!-- Toaster container -->
  <div class="toast-container" id="toastContainer" aria-live="polite"></div>

  <div class="container" role="main">
    <div>
      <div class="brand" aria-hidden="true"><div class="logo">LB</div><h1>LA ZONA DEL BARBERO ‚Äî Agendamiento</h1></div>

      <div class="card" id="mainCard" role="form" aria-labelledby="formTitle">
        <h2 id="formTitle">Reservar cita</h2>
        <p class="muted">Rellena los datos. Al confirmar se guarda en la agenda y se abre WhatsApp.</p>

        <!-- stepper -->
        <div class="stepper" aria-hidden="false">
          <div class="step active" id="step1">1</div>
          <div class="step" id="step2">2</div>
          <div class="muted" style="margin-left:auto">Nombre ‚Üí Apellido</div>
        </div>

        <!-- tabs -->
        <div class="tabs" aria-hidden="false">
          <div class="tab-panels" id="tabPanels" style="transform:translateX(0%)">
            <div class="tab-panel">
              <label for="nombre">Nombre *</label>
              <input id="nombre" type="text" placeholder="Juan" autocomplete="given-name" />
            </div>
            <div class="tab-panel">
              <label for="apellido">Apellido *</label>
              <input id="apellido" type="text" placeholder="P√©rez" autocomplete="family-name" />
            </div>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-ghost" id="prevTab" type="button" aria-label="Atr√°s">Atr√°s</button>
            <button class="btn btn-primary" id="nextTab" type="button" aria-label="Siguiente">Siguiente</button>
          </div>
        </div>

        <label for="telefono">Tel√©fono *</label>
        <input id="telefono" type="tel" placeholder="+57 3XX XXX XXXX" autocomplete="tel">

        <label for="email">Correo</label>
        <input id="email" type="email" placeholder="ejemplo@correo.com" autocomplete="email">

        <label for="barbero">Barbero *</label>
        <select id="barbero" aria-required="true">
          <option value="">Seleccionar...</option>
          <option value="Dylan">Dylan</option>
          <option value="Santiago">Santiago</option>
          <option value="Alejandro">Alejandro</option>
          <option value="Leonardo">Leonardo</option>
        </select>

        <label for="servicio">Servicio * <span class="muted">(precio en COP)</span></label>
        <select id="servicio">
          <option value="">Seleccionar...</option>
          <option value="Corte" data-price="18000" data-duration="30">Corte ‚Äî $18.000 ‚Äî 30 min</option>
          <option value="Corte + ceja" data-price="22000" data-duration="45">Corte + ceja ‚Äî $22.000 ‚Äî 45 min</option>
          <option value="Corte + barba" data-price="23000" data-duration="45">Corte + barba ‚Äî $23.000 ‚Äî 45 min</option>
          <option value="Corte + barba + ceja" data-price="25000" data-duration="65">Corte + barba + ceja ‚Äî $25.000 ‚Äî 65 min</option>
          <option value="Corte VIP" data-price="65000" data-duration="150">Corte VIP ‚Äî $65.000 ‚Äî 2 h 30 min</option>
        </select>

        <label for="fecha">Fecha *</label>
        <input id="fecha" type="date">

        <label>Hora *</label>
        <div id="availableList" class="available-list" aria-live="polite">Selecciona servicio (sugerencias). Luego elige barbero y fecha para disponibilidad real.</div>

        <div style="height:8px"></div>
        <select id="horaSelect" aria-label="Seleccionar hora"><option value="">Selecciona hora...</option></select>

        <div style="display:flex;gap:10px;margin-top:14px;align-items:center">
          <button id="btnGuardar" class="btn btn-primary" type="button">Confirmar y enviar WhatsApp</button>
          <button id="btnLimpiar" class="btn btn-ghost" type="button">Limpiar</button>
          <div id="status" style="margin-left:8px"></div>
        </div>

        <div class="meta">Horario operativo: <strong>10:00 ‚Äî 21:00</strong></div>

        <div id="resumenCita" class="res-box" style="display:none" aria-live="polite">
          <h3 style="margin:0 0 8px 0">üìå Resumen de la cita</h3>
          <div class="muted">Cliente: <strong id="resNombre"></strong></div>
          <div class="muted">Barbero: <strong id="resBarbero"></strong></div>
          <div class="muted">Servicio: <strong id="resServicio"></strong></div>
          <div class="muted">Fecha: <strong id="resFecha"></strong></div>
          <div class="muted">Hora: <strong id="resHora"></strong></div>

          <div style="height:8px"></div>
          <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-bottom:8px">
            <div style="font-weight:700;color:var(--text)">üíà Tu tiempo es importante.</div>
            <div class="muted" style="margin-top:6px">Si necesitas cancelar, av√≠sanos <strong>10 minutos antes</strong> por WhatsApp.</div>
            <div style="margin-top:10px"><a id="whatsappBtn" class="btn btn-primary" href="https://wa.me/573233489369" target="_blank" style="display:inline-block;text-decoration:none">Avisar por WhatsApp</a></div>
          </div>
        </div>
      </div>

      <!-- place for extra content if needed -->
    </div>

    <div class="card summary-card" aria-labelledby="summaryTitle">
      <h3 id="summaryTitle">Resumen</h3>
      <div class="muted">Servicio: <strong id="summaryService">-</strong></div>
      <div class="muted">Duraci√≥n: <strong id="summaryDuration">-</strong></div>
      <div style="height:8px"></div>
      <div class="muted">Precio: <strong id="summaryPrice">-</strong></div>
      <div style="height:10px"></div>
      <h3 style="margin:8px 0">Horas (vista)</h3>
      <div id="slotsBox" class="available-list muted">Sin datos.</div>
    </div>
  </div>

  <!-- SCRIPT: Firebase + l√≥gica + validaciones + toasts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, get, child, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // firebase config (igual que siempre)
    const firebaseConfig = {
      apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
      authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
      databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
      projectId: "lazonadelbarbero-b4e75",
      storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
      messagingSenderId: "251180096928",
      appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
      measurementId: "G-G4YL7M4Z00"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const OPEN_MIN = 10 * 60;
    const CLOSE_MIN = 21 * 60;

    // DOM
    const servicioEl = document.getElementById('servicio');
    const barberoEl = document.getElementById('barbero');
    const fechaEl = document.getElementById('fecha');
    const horaSelect = document.getElementById('horaSelect');
    const availableList = document.getElementById('availableList');
    const slotsBox = document.getElementById('slotsBox');
    const summaryService = document.getElementById('summaryService');
    const summaryDuration = document.getElementById('summaryDuration');
    const summaryPrice = document.getElementById('summaryPrice');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const status = document.getElementById('status');

    const resumenCita = document.getElementById('resumenCita');
    const resNombre = document.getElementById('resNombre');
    const resBarbero = document.getElementById('resBarbero');
    const resServicio = document.getElementById('resServicio');
    const resFecha = document.getElementById('resFecha');
    const resHora = document.getElementById('resHora');
    const whatsappBtn = document.getElementById('whatsappBtn');

    // tab elements
    const tabPanels = document.getElementById('tabPanels');
    const steps = [document.getElementById('step1'), document.getElementById('step2')];
    const prevTab = document.getElementById('prevTab');
    const nextTab = document.getElementById('nextTab');
    const nombreInput = document.getElementById('nombre');
    const apellidoInput = document.getElementById('apellido');
    let tabIndex = 0;

    // Toast helpers
    const toastContainer = document.getElementById('toastContainer');
    function showToast(msg, type = 'error'){
      const el = document.createElement('div');
      el.className = 'toast ' + (type === 'success' ? 'success' : 'error');
      el.textContent = msg;
      toastContainer.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(),400); }, 3000);
    }

    // helpers
    function parseDuration(){ return Number(servicioEl.selectedOptions[0]?.dataset.duration) || 0; }
    function parsePrice(){ return Number(servicioEl.selectedOptions[0]?.dataset.price) || 0; }

    function minutesToShortAmPm(m){
      const hh = Math.floor(m/60);
      const mm = m % 60;
      const isPM = hh >= 12;
      let h12 = hh % 12;
      if(h12 === 0) h12 = 12;
      const mmPart = mm === 0 ? '' : `:${String(mm).padStart(2,'0')}`;
      return `${h12}${mmPart}${isPM ? 'pm' : 'am'}`;
    }
    function minutesToAmPmWithSpace(m){
      let hh = Math.floor(m/60); const mm = String(m%60).padStart(2,'0');
      const ampm = hh >= 12 ? 'PM' : 'AM'; hh = hh % 12; if(hh===0) hh=12;
      return `${hh}:${mm} ${ampm}`;
    }

    // set min date to today
    (function(){ const t=new Date(); const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0'); fechaEl.min = `${y}-${m}-${d}`; })();

    // VALIDACIONES estrictas
    function validateName(str){ return /^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√± ]{2,30}$/.test(str); }
    function validatePhoneStrict(p){ p = (p||'').replace(/\s+/g,''); return /^(?:\+57|57)?3\d{9}$/.test(p); }
    function validateEmail(email){ if(!email) return true; return /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test(email); }
    function validateDate(dateStr){ if(!dateStr) return false; const today=new Date(); today.setHours(0,0,0,0); const date=new Date(dateStr); if(date < today) return false; return true; }
    function validateHour(startMinutes, duration){ if(isNaN(startMinutes)) return false; const end = startMinutes + duration; return startMinutes >= OPEN_MIN && end <= CLOSE_MIN; }

    // Firebase helpers
    async function fetchAppointmentsRT(barbero, dateISO){
      const path = `appointments/${barbero}/${dateISO}`;
      const snap = await get(child(ref(db), path));
      const arr = [];
      if(snap.exists()){
        const val = snap.val();
        for(const key of Object.keys(val)){
          const a = val[key];
          a._id = key;
          a.startMinutes = Number(a.startMinutes);
          a.durationMinutes = Number(a.durationMinutes);
          a.endMinutes = Number(a.endMinutes || (a.startMinutes + a.durationMinutes));
          a.nombre = a.nombre || '';
          a.servicio = a.servicio || '';
          arr.push(a);
        }
        arr.sort((a,b)=>a.startMinutes - b.startMinutes);
      }
      return arr;
    }

    function buildOccupied(appts){
      const iv = appts.map(a=>({start:a.startMinutes, end:a.endMinutes})).sort((a,b)=>a.start-b.start);
      const merged = [];
      for(const x of iv){
        if(!merged.length || x.start > merged[merged.length-1].end) merged.push({...x});
        else merged[merged.length-1].end = Math.max(merged[merged.length-1].end, x.end);
      }
      return merged;
    }

    function generateCandidateStarts(duration){
      const out=[];
      for(let t=OPEN_MIN; t+duration<=CLOSE_MIN; t+=duration) out.push(t);
      return out;
    }
    function isConflict(s,e,occupied){ return occupied.some(iv => s < iv.end && e > iv.start); }

    // availability UI
    async function refreshAvailability(){
      const service = servicioEl.value;
      const duration = parseDuration();
      summaryService.textContent = service || '-';
      summaryDuration.textContent = duration ? duration : '-';
      summaryPrice.textContent = parsePrice() ? `$${parsePrice().toLocaleString('es-CO')}` : '-';

      const barbero = barberoEl.value;
      const dateVal = fechaEl.value;

      availableList.innerHTML = '';
      slotsBox.innerHTML = '';
      horaSelect.innerHTML = '<option value="">Selecciona hora...</option>';

      if(!service || !duration){
        availableList.innerHTML = 'Selecciona un servicio para ver sugerencias.';
        slotsBox.textContent = 'Sin datos.';
        return;
      }

      const candidates = generateCandidateStarts(duration);

      if(!barbero || !dateVal){
        availableList.innerHTML = 'Sugerencias (elige barbero y fecha para disponibilidad real):';
        candidates.forEach(s=>{
          const div = document.createElement('div');
          div.className = 'slot';
          div.textContent = `${minutesToShortAmPm(s)} ‚Äî ${duration} min`;
          div.onclick = ()=>{ horaSelect.value = s; document.querySelectorAll('.slot').forEach(x=>x.classList.remove('selected')); div.classList.add('selected'); };
          slotsBox.appendChild(div);
          const opt = document.createElement('option'); opt.value = s; opt.textContent = minutesToShortAmPm(s); horaSelect.appendChild(opt);
        });
        return;
      }

      availableList.innerHTML = '<div class="muted">Cargando disponibilidad... <span class="loader" aria-hidden="true"></span></div>';
      try{
        const appts = await fetchAppointmentsRT(barbero, dateVal);
        const occupied = buildOccupied(appts);
        availableList.textContent = `Disponibilidad para ${barbero} el ${dateVal}:`;

        let any=false;
        const frag = document.createDocumentFragment();
        for(const s of candidates){
          const e = s + duration;
          if(e > CLOSE_MIN) continue;
          const div = document.createElement('div');
          div.className = 'slot';
          if(isConflict(s,e,occupied)){
            div.classList.add('busy');
            div.textContent = `${minutesToShortAmPm(s)} ‚Äî Ocupado`;
            frag.appendChild(div);
            continue;
          }
          any=true;
          div.textContent = `${minutesToShortAmPm(s)}`;
          div.onclick = ()=>{ horaSelect.value = s; document.querySelectorAll('.slot').forEach(x=>x.classList.remove('selected')); div.classList.add('selected'); };
          frag.appendChild(div);
          const opt = document.createElement('option'); opt.value = s; opt.textContent = minutesToShortAmPm(s); horaSelect.appendChild(opt);
        }
        slotsBox.appendChild(frag);

        if(!any){
          slotsBox.innerHTML = '<div class="muted">No hay horas libres para este servicio en esta fecha.</div>';
          horaSelect.innerHTML = '<option value="">No disponible</option>';
        } else {
          if(appts.length){
            const hr = document.createElement('div'); hr.style.marginTop='8px'; hr.style.borderTop='1px dashed rgba(255,255,255,0.04)'; hr.style.paddingTop='8px';
            const title = document.createElement('div'); title.className='muted'; title.textContent='Reservas existentes:';
            hr.appendChild(title);
            appts.forEach(a=>{
              const el = document.createElement('div'); el.className='muted'; el.textContent = `${minutesToShortAmPm(a.startMinutes)} ‚Üí ${minutesToShortAmPm(a.endMinutes)} ‚Äî ${a.servicio} ‚Äî ${a.nombre || 'Cliente'}`;
              hr.appendChild(el);
            });
            slotsBox.appendChild(hr);
          }
        }
      }catch(err){
        console.error(err);
        availableList.innerHTML = 'Error cargando disponibilidad.';
        slotsBox.textContent = '-';
        horaSelect.innerHTML = '<option value="">Error</option>';
      }
    }

    servicioEl.addEventListener('change', refreshAvailability);
    barberoEl.addEventListener('change', refreshAvailability);
    fechaEl.addEventListener('change', refreshAvailability);

    // phone validation fallback (keeps original behaviour but we use stricter later)
    function validatePhone(p){ return /^\+?57\s?3\d{2}\s?\d{3}\s?\d{3}$/.test(p) || /^3\d{9}$/.test(p); }

    // clear
    btnLimpiar.addEventListener('click', ()=>{ 
      document.getElementById('nombre').value=''; document.getElementById('apellido').value=''; document.getElementById('telefono').value=''; document.getElementById('email').value=''; 
      horaSelect.innerHTML='<option value="">Selecciona hora...</option>'; availableList.innerHTML='Selecciona servicio (sugerencias). Luego elige barbero y fecha para ver disponibilidad real.'; slotsBox.innerHTML=''; 
      summaryService.textContent='-'; summaryDuration.textContent='-'; summaryPrice.textContent='-';
      resumenCita.style.display = 'none';
      showToast('Formulario limpiado','success');
    });

    // submit with stricter validations + toasts
    let submitting=false;
    btnGuardar.addEventListener('click', async ()=>{
      if(submitting) return;
      const nombre = document.getElementById('nombre').value.trim();
      const apellido = document.getElementById('apellido').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const email = document.getElementById('email').value.trim();
      const barbero = barberoEl.value;
      const servicio = servicioEl.value;
      const duration = parseDuration();
      const price = parsePrice();
      const dateVal = fechaEl.value;
      const startMinutes = Number(horaSelect.value);

      // validations (strict)
      if(!validateName(nombre)){ showToast('Nombre inv√°lido (solo letras, m√≠nimo 2 caracteres).','error'); return; }
      if(!validateName(apellido)){ showToast('Apellido inv√°lido.','error'); return; }
      if(!validatePhoneStrict(telefono)){ showToast('Tel√©fono inv√°lido. Usa formato colombiano (+57 3XXXXXXXXX).','error'); return; }
      if(!validateEmail(email)){ showToast('Correo inv√°lido.','error'); return; }
      if(!barbero){ showToast('Selecciona un barbero.','error'); return; }
      if(!servicio){ showToast('Selecciona un servicio.','error'); return; }
      if(!validateDate(dateVal)){ showToast('Fecha inv√°lida (no puedes reservar en fechas pasadas).','error'); return; }
      if(!validateHour(startMinutes,duration)){ showToast('Hora fuera del horario permitido.','error'); return; }

      submitting=true; btnGuardar.disabled=true; status.innerHTML = '<span class="loader" aria-hidden="true"></span>';

      try{
        const appts = await fetchAppointmentsRT(barbero, dateVal);
        const occupied = buildOccupied(appts);
        const endMinutes = startMinutes + duration;

        if(isConflict(startMinutes, endMinutes, occupied)){
          showToast('La hora ya no est√° disponible. Actualiza disponibilidad y elige otra.','error');
          submitting=false; btnGuardar.disabled=false; status.innerHTML=''; return;
        }

        const parentPath = `appointments/${barbero}/${dateVal}`;
        const parentRef = ref(db, parentPath);

        await runTransaction(parentRef, (current) => {
          if(current === null) current = {};
          const existing = Object.values(current || {}).map(x => ({ start: Number(x.startMinutes), end: Number(x.endMinutes || (Number(x.startMinutes) + Number(x.durationMinutes))) }));
          existing.sort((a,b)=>a.start-b.start);
          for(const iv of existing) if(startMinutes < iv.end && endMinutes > iv.start) throw new Error('CONFLICT');

          const key = String(startMinutes);
          current[key] = {
            nombre: `${nombre} ${apellido}`,
            telefono,
            email: email || '',
            barbero,
            servicio,
            durationMinutes: duration,
            startMinutes,
            endMinutes,
            date: dateVal,
            priceCOP: price,
            createdAt: Date.now()
          };
          return current;
        });

        // prepare whatsapp message
        const horaNice = minutesToAmPmWithSpace(startMinutes);
        const msg = 
`üíà *NUEVA RESERVA* üíà

üë§ *Cliente:* ${nombre} ${apellido}
üìû *Tel√©fono:* ${telefono}
‚úâÔ∏è *Correo:* ${email || 'No registrado'}

üíá‚Äç‚ôÇÔ∏è *Servicio:* ${servicio}
‚è± *Duraci√≥n:* ${duration} min
üí≤ *Precio:* $${price.toLocaleString('es-CO')}

üßî‚Äç‚ôÇÔ∏è *Barbero:* ${barbero}
üìÖ *Fecha:* ${dateVal}
‚è∞ *Hora:* ${horaNice}

‚ú® Gracias por agendar en *LA ZONA DEL BARBERO*.`;

        const phoneDest = '573233489369';
        window.open(`https://api.whatsapp.com/send?phone=${phoneDest}&text=${encodeURIComponent(msg)}`, '_blank');

        // UI resumen
        resNombre.textContent = `${nombre} ${apellido}`;
        resBarbero.textContent = barbero;
        resServicio.textContent = servicio;
        resFecha.textContent = dateVal;
        resHora.textContent = minutesToShortAmPm(startMinutes);
        resumenCita.style.display = 'block';
        whatsappBtn.href = `https://wa.me/${phoneDest}`;

        showToast('Cita guardada correctamente.','success');
        await refreshAvailability();
      } catch(err){
        console.error('Transaction error:', err);
        if(String(err).includes('CONFLICT')) showToast('La hora no est√° disponible (conflicto).','error');
        else showToast('Error guardando la cita. Revisa la consola.','error');
      } finally {
        submitting=false; btnGuardar.disabled=false; status.innerHTML='';
      }
    });

    // initial load
    refreshAvailability();

    /* --- UI: splash hide + tabs behavior --- */
    const splash = document.getElementById('splash');
    window.addEventListener('load', ()=>{
      setTimeout(()=>{
        splash.style.transition='opacity .5s ease, transform .5s ease';
        splash.style.opacity='0'; splash.style.transform='scale(.98)';
        setTimeout(()=>splash.remove(),500);
      }, 600);
    });

    // Tabs / stepper logic
    function updateTabs(){
      tabPanels.style.transform = `translateX(-${tabIndex * 100}%)`;
      steps.forEach((s,i)=> s.classList.toggle('active', i === tabIndex));
      prevTab.disabled = tabIndex === 0;
      nextTab.textContent = tabIndex === 0 ? 'Siguiente' : 'Listo';
      setTimeout(()=>{ if(tabIndex===0) nombreInput.focus(); else apellidoInput.focus(); }, 200);
    }
    prevTab.addEventListener('click', ()=>{ if(tabIndex>0){ tabIndex--; updateTabs(); } });
    nextTab.addEventListener('click', ()=>{
      if(tabIndex === 0){
        if(!nombreInput.value.trim()){ nombreInput.animate([{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:180}); nombreInput.focus(); showToast('Ingresa tu nombre','error'); return; }
        tabIndex = 1; updateTabs();
      } else {
        if(!apellidoInput.value.trim()){ apellidoInput.animate([{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:180}); apellidoInput.focus(); showToast('Ingresa tu apellido','error'); return; }
        document.getElementById('telefono').focus();
      }
    });
    nombreInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); nextTab.click(); } });
    apellidoInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); nextTab.click(); } });
    updateTabs();

    // showToast exposures (make accessible)
    function showToast(msg, type='error'){
      const el = document.createElement('div');
      el.className = 'toast ' + (type === 'success' ? 'success' : 'error');
      el.textContent = msg;
      toastContainer.appendChild(el);
      // let it in for a bit
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(),400); }, 3000);
    }
  </script>
</body>
</html>
