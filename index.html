<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>La Zona del Barbero - Agendar Cita</title>
<style>
    body {
        margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: #111;
        color: #fff;
    }
    .container {
        max-width: 500px;
        margin: 50px auto;
        padding: 20px;
        background-color: #1a1a1a;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    h1 {
        text-align: center;
        font-size: 2em;
        color: #fff;
        margin-bottom: 20px;
        text-shadow: 0 0 10px #fff;
    }
    label {
        display: block;
        margin-top: 15px;
        font-weight: bold;
    }
    input, select {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 5px;
        border: none;
        background-color: #222;
        color: #fff;
    }
    input[type="date"] {
        color-scheme: dark;
    }
    button {
        margin-top: 20px;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 5px;
        background-color: #555;
        color: #fff;
        font-size: 1em;
        cursor: pointer;
    }
    button:hover {
        background-color: #777;
    }
    .success {
        margin-top: 20px;
        padding: 10px;
        background-color: #2a2;
        border-radius: 5px;
        text-align: center;
        display: none;
    }
</style>
</head>
<body>
<div class="container">
    <h1>LA ZONA DEL BARBERO</h1>
    <form id="formCita">
        <label>Nombre</label>
        <input type="text" id="nombre" required>

        <label>Apellido</label>
        <input type="text" id="apellido" required>

        <label>Teléfono</label>
        <input type="tel" id="telefono" required>

        <label>Correo Electrónico</label>
        <input type="email" id="correo" required>

        <label>Seleccionar Barbero</label>
        <select id="barbero" required>
            <option value="Dylan">Dylan</option>
            <option value="Alex">Alex</option>
        </select>

        <label>Seleccionar Servicio</label>
        <select id="servicio" required>
            <option value="Corte" data-duracion="30" data-precio="18000">Corte - $18.000</option>
            <option value="Corte + Ceja" data-duracion="40" data-precio="22000">Corte + Ceja - $22.000</option>
            <option value="Corte + Ceja + Barba" data-duracion="60" data-precio="25000">Corte + Ceja + Barba - $25.000</option>
            <option value="Corte + Limpieza Facial" data-duracion="150" data-precio="65000">Corte + Limpieza Facial - $65.000</option>
        </select>

        <label>Programar Fecha</label>
        <input type="date" id="fecha" required min="<?php echo date('Y-m-d'); ?>">

        <label>Programar Hora</label>
        <select id="hora" required></select>

        <button type="submit">Agendar Cita</button>
    </form>
    <div class="success" id="mensajeExito">Cita agendada correctamente! Redirigiendo a WhatsApp...</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyD0XwAGFWJEFs6_bpPLQGSVeVPyTkymk6I",
    authDomain: "shantybarber-b7b8c.firebaseapp.com",
    databaseURL: "https://shantybarber-b7b8c-default-rtdb.firebaseio.com",
    projectId: "shantybarber-b7b8c",
    storageBucket: "shantybarber-b7b8c.appspot.com",
    messagingSenderId: "568694643758",
    appId: "1:568694643758:web:c1bbf8a68f6e9e3d4ad3bf",
    measurementId: "G-JXMJM9Q3X1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const servicioSelect = document.getElementById('servicio');
const barberoSelect = document.getElementById('barbero');
const fechaInput = document.getElementById('fecha');
const horaSelect = document.getElementById('hora');

const horasDisponibles = ["10:00","10:40","11:20","12:00","12:40","13:20","14:00","14:40","15:20","16:00","16:40","17:20","18:00","18:40","19:20","20:00","20:40"];

async function actualizarHoras() {
    const barbero = barberoSelect.value;
    const fecha = fechaInput.value;
    const duracion = parseInt(servicioSelect.selectedOptions[0].dataset.duracion);
    horaSelect.innerHTML = '';

    // Obtener citas existentes
    const snapshot = await db.collection('citas')
        .where('barbero','==',barbero)
        .where('fecha','==',fecha)
        .get();

    const bloqueos = [];
    snapshot.forEach(doc => {
        const inicio = doc.data().hora;
        const dur = doc.data().duracion;
        bloqueos.push({inicio,duracion: dur});
    });

    horasDisponibles.forEach(h => {
        const hSplit = h.split(':');
        let hDate = new Date();
        hDate.setHours(parseInt(hSplit[0]));
        hDate.setMinutes(parseInt(hSplit[1]));
        hDate.setSeconds(0);

        // Verificar si bloqueado
        let disponible = true;
        bloqueos.forEach(b => {
            const [bH, bM] = b.inicio.split(':');
            const start = new Date();
            start.setHours(parseInt(bH));
            start.setMinutes(parseInt(bM));
            const end = new Date(start.getTime() + b.duracion*60000);
            const citaEnd = new Date(hDate.getTime() + duracion*60000);
            if( (hDate >= start && hDate < end) || (citaEnd > start && citaEnd <= end) ){
                disponible = false;
            }
        });
        if(disponible){
            const option = document.createElement('option');
            option.value = h;
            option.textContent = h;
            horaSelect.appendChild(option);
        }
    });
}

servicioSelect.addEventListener('change', actualizarHoras);
barberoSelect.addEventListener('change', actualizarHoras);
fechaInput.addEventListener('change', actualizarHoras);

document.getElementById('formCita').addEventListener('submit', async function(e){
    e.preventDefault();
    const nombre = document.getElementById('nombre').value;
    const apellido = document.getElementById('apellido').value;
    const telefono = document.getElementById('telefono').value;
    const correo = document.getElementById('correo').value;
    const barbero = barberoSelect.value;
    const servicio = servicioSelect.value;
    const duracion = parseInt(servicioSelect.selectedOptions[0].dataset.duracion);
    const fecha = fechaInput.value;
    const hora = horaSelect.value;
    const precio = parseInt(servicioSelect.selectedOptions[0].dataset.precio);

    // Guardar en Firestore
    await db.collection('citas').add({
        nombre, apellido, telefono, correo, barbero, servicio, fecha, hora, duracion, precio
    });

    // Mostrar mensaje y redirigir a WhatsApp
    document.getElementById('mensajeExito').style.display = 'block';
    const mensaje = `Cita Confirmada: ${nombre} ${apellido}, Servicio: ${servicio}, Barbero: ${barbero}, Fecha: ${fecha}, Hora: ${hora}`;
    const urlWhats = `https://api.whatsapp.com/send?phone=573233489369&text=${encodeURIComponent(mensaje)}`;
    setTimeout(()=>{ window.open(urlWhats,'_blank'); }, 1500);
});
</script>
</body>
</html>
