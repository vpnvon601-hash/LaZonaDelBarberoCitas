<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LA ZONA DEL BARBERO ‚Äî Agendamiento</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0a0c;
      --card:#131316;
      --surface:#1c1c1f;
      --line:#2a2a2d;
      --text:#ffffff;
      --muted:#b8b8bb;
      --accent:#0ea5e9;
      --radius:16px;
      --shadow:0 8px 22px rgba(0,0,0,0.45);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{background:var(--bg);color:var(--text);padding:28px;}
    .container{max-width:1050px;margin:0 auto;}
    .header{text-align:center;margin-bottom:30px;}
    .header h1{font-size:30px;font-weight:700;letter-spacing:-0.4px;}
    .header p{color:var(--muted);margin-top:6px;font-size:14px;}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:24px;}
    @media(max-width:900px){ .grid{grid-template-columns:1fr;padding:12px;} }

    .card{
      background:var(--card);
      padding:24px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.03);
    }

    h2{font-size:20px;font-weight:600;margin-bottom:16px;color:#ffffff;}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--surface);
      color:var(--text);
      font-size:15px;
      margin-bottom:14px;
      outline:none;
      transition:box-shadow .18s,border-color .18s;
    }
    input:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 6px 16px rgba(14,165,233,0.22);
    }

    button{
      padding:12px 16px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size:15px;
    }

    .btn-primary{
      background:var(--accent);
      color:#000;
    }
    .btn-primary:hover{filter:brightness(.95);}
    .btn-ghost{
      background:transparent;
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.04);
    }

    .muted{color:var(--muted);font-size:13px}

    .available-box{
      background:var(--surface);
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      max-height:320px;
      overflow:auto;
      box-shadow:inset 0 0 8px rgba(0,0,0,0.25);
    }

    .slot{
      padding:12px;
      border-radius:10px;
      background:#171718;
      margin-bottom:10px;
      cursor:pointer;
      transition:background .16s,transform .08s;
      border:1px solid transparent;
      display:flex;
      justify-content:space-between;
    }
    .slot:hover{background:#202024;transform:translateY(-2px);}
    .slot.busy{background:#351b1b;color:#ff9b9b;border-color:#7a2a2a;cursor:not-allowed}
    .slot.selected{background:var(--accent);color:#000;font-weight:700;}

    /* TOASTS APPLE STYLE */
    .toast-container{
      position:fixed;
      bottom:24px;
      right:24px;
      z-index:999999;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .toast{
      background:rgba(20,20,22,0.92);
      border:1px solid rgba(255,255,255,0.07);
      color:#fff;
      padding:14px 18px;
      border-radius:14px;
      font-size:14px;
      min-width:260px;
      max-width:350px;
      backdrop-filter:blur(12px);
      box-shadow:0 6px 14px rgba(0,0,0,0.45);
      opacity:0;
      transform:translateY(10px);
      animation:toast-in .35s ease forwards;
    }

    .toast.success{border-left:4px solid #4ade80;}
    .toast.error{border-left:4px solid #f87171;}

    @keyframes toast-in{
      to{opacity:1;transform:translateY(0);}
    }
    @keyframes toast-out{
      to{opacity:0;transform:translateY(10px);}
    }

    .res-box{
      background:#0e1416;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.04);
      margin-top:14px;
    }
  </style>
</head>

<body>
<div class="toast-container" id="toastContainer"></div>
<script>
function showToast(message,type="error"){
  const container=document.getElementById("toastContainer");
  const toast=document.createElement("div");
  toast.className=`toast ${type}`;
  toast.innerHTML=message;
  container.appendChild(toast);
  setTimeout(()=>{
    toast.style.animation="toast-out .4s forwards";
    setTimeout(()=>toast.remove(),400);
  },2600);
}
</script>

<div class="container">
  <div class="header">
    <h1>LA ZONA DEL BARBERO ‚Äî Agendamiento</h1>
    <p>LA ZONA DEL BARBERO es un espacio dise√±ado para quienes buscan m√°s que un corte: una experiencia.
Nuestra barber√≠a combina t√©cnica avanzada, precisi√≥n y estilo, entregando resultados limpios, modernos y personalizados para cada cliente.

Contamos con barberos especializados, ambiente premium y un enfoque totalmente profesional que garantiza un servicio puntual, elegante y de alta calidad.
Cada detalle, desde la atenci√≥n hasta el acabado final, est√° pensado para que salgas con una imagen renovada y una experiencia inolvidable.</p>
  </div>

  <div class="grid">

    <!-- FORMULARIO -->
    <div class="card">
      <h2>Reservar cita</h2>

      <label>Nombre *</label>
      <input id="nombre" type="text">

      <label>Apellido *</label>
      <input id="apellido" type="text">

      <label>Tel√©fono *</label>
      <input id="telefono" type="tel">

      <label>Correo</label>
      <input id="email" type="email">

      <label>Barbero *</label>
      <select id="barbero">
        <option value="">Seleccionar...</option>
        <option value="Dylan">Dylan</option>
        <option value="Santiago">Santiago</option>
        <option value="Alejandro">Alejandro</option>
        <option value="Leonardo">Leonardo</option>
      </select>

      <label>Servicio *</label>
      <select id="servicio">
        <option value="">Seleccionar...</option>
        <option value="Corte" data-price="18000" data-duration="30">Corte ‚Äî $18.000 ‚Äî 30 min</option>
        <option value="Corte + ceja" data-price="22000" data-duration="45">Corte + ceja ‚Äî $22.000 ‚Äî 45 min</option>
        <option value="Corte + barba" data-price="23000" data-duration="45">Corte + barba ‚Äî 45 min ‚Äî $23.000</option>
        <option value="Corte + barba + ceja" data-price="25000" data-duration="65">Corte + barba + ceja ‚Äî $25.000 ‚Äî 65 min</option>
        <option value="Corte VIP" data-price="65000" data-duration="150">Corte VIP ‚Äî $65.000 ‚Äî 2 h 30 min</option>
      </select>

      <label>Fecha *</label>
      <input id="fecha" type="date">

      <label>Hora *</label>
      <div id="availableList" class="available-box">Selecciona servicio para ver sugerencias‚Ä¶</div>

      <select id="horaSelect" style="margin-top:10px">
        <option value="">Selecciona hora‚Ä¶</option>
      </select>

      <div style="display:flex;gap:12px;margin-top:18px">
        <button class="btn-primary" id="btnGuardar">Confirmar</button>
        <button class="btn-ghost" id="btnLimpiar">Limpiar</button>
        <div id="status"></div>
      </div>

      <div class="muted" style="margin-top:12px">Horario: 10:00am ‚Äì 9:00pm</div>

      <div id="resumenCita" class="res-box" style="display:none">
        <h4>üìå Resumen</h4>
        <div class="muted">Cliente: <strong id="resNombre"></strong></div>
        <div class="muted">Barbero: <strong id="resBarbero"></strong></div>
        <div class="muted">Servicio: <strong id="resServicio"></strong></div>
        <div class="muted">Fecha: <strong id="resFecha"></strong></div>
        <div class="muted">Hora: <strong id="resHora"></strong></div>
        <a id="whatsappBtn" target="_blank" style="margin-top:10px;display:inline-block;background:#25D366;padding:10px 14px;border-radius:10px;text-decoration:none;color:#000;font-weight:700">Avisar por WhatsApp</a>
      </div>
    </div>

    <!-- PANEL RESUMEN -->
    <div class="card">
      <h2>Resumen</h2>
      <div class="muted">Servicio: <strong id="summaryService">-</strong></div>
      <div class="muted">Duraci√≥n: <strong id="summaryDuration">-</strong> min</div>
      <div class="muted">Precio: <strong id="summaryPrice">-</strong></div>

      <div style="margin-top:12px">Horas (vista)</div>
      <div id="slotsBox" class="available-box">Sin datos.</div>
    </div>

  </div>
</div>
<script type="module">
/* ------------------------ IMPORTS FIREBASE ------------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, get, child, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ------------------------ TU CONFIG FIREBASE ------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
  authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
  databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
  projectId: "lazonadelbarbero-b4e75",
  storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
  messagingSenderId: "251180096928",
  appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
  measurementId: "G-G4YL7M4Z00"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ------------------------ CONSTANTES ------------------------ */
const OPEN_MIN = 10 * 60;  // 10:00
const CLOSE_MIN = 21 * 60; // 21:00

/* ------------------------ DOM ELEMENTS ------------------------ */
const servicioEl = document.getElementById('servicio');
const barberoEl = document.getElementById('barbero');
const fechaEl = document.getElementById('fecha');
const horaSelect = document.getElementById('horaSelect');
const availableList = document.getElementById('availableList');
const slotsBox = document.getElementById('slotsBox');
const summaryService = document.getElementById('summaryService');
const summaryDuration = document.getElementById('summaryDuration');
const summaryPrice = document.getElementById('summaryPrice');
const btnGuardar = document.getElementById('btnGuardar');
const btnLimpiar = document.getElementById('btnLimpiar');
const status = document.getElementById('status');

/* Resumen final */
const resumenCita = document.getElementById('resumenCita');
const resNombre = document.getElementById('resNombre');
const resBarbero = document.getElementById('resBarbero');
const resServicio = document.getElementById('resServicio');
const resFecha = document.getElementById('resFecha');
const resHora = document.getElementById('resHora');
const whatsappBtn = document.getElementById('whatsappBtn');

/* ------------------------ HELPERS ------------------------ */
function parseDuration(){ return Number(servicioEl.selectedOptions[0]?.dataset.duration) || 0; }
function parsePrice(){ return Number(servicioEl.selectedOptions[0]?.dataset.price) || 0; }

/* Convert hours */
function minutesToShortAmPm(m){
  const hh = Math.floor(m/60);
  const mm = m % 60;
  const isPM = hh >= 12;
  let h12 = hh % 12;
  if(h12 === 0) h12 = 12;
  const mmPart = mm === 0 ? '' : `:${String(mm).padStart(2,'0')}`;
  return `${h12}${mmPart}${isPM ? 'pm' : 'am'}`;
}

function minutesToAmPmWithSpace(m){
  let hh = Math.floor(m/60);
  const mm = String(m%60).padStart(2,'0');
  const ampm = hh >= 12 ? 'PM' : 'AM';
  hh = hh % 12; 
  if(hh===0) hh=12;
  return `${hh}:${mm} ${ampm}`;
}

/* Fecha m√≠nima es HOY */
(function(){
  const t = new Date();
  const y = t.getFullYear();
  const m = String(t.getMonth()+1).padStart(2,'0');
  const d = String(t.getDate()).padStart(2,'0');
  fechaEl.min = `${y}-${m}-${d}`;
})();

/* ------------------------ VALIDACIONES ESTRICTAS ------------------------ */
function validateName(str){
  return /^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√± ]{2,30}$/.test(str);
}

function validatePhoneStrict(p){
  p = p.replace(/\s+/g,'');
  return /^(?:\+57|57)?3\d{9}$/.test(p);
}

function validateEmail(email){
  if(!email) return true; // opcional
  return /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test(email);
}

function validateDate(dateStr){
  if(!dateStr) return false;
  const today = new Date(); today.setHours(0,0,0,0);
  const date = new Date(dateStr);
  if(date < today) return false; // no fechas pasadas
  return true;
}

function validateHour(startMinutes, duration){
  if(isNaN(startMinutes)) return false;
  const end = startMinutes + duration;
  return startMinutes >= OPEN_MIN && end <= CLOSE_MIN;
}

/* ------------------------ FIREBASE: OBTENER CITAS ------------------------ */
async function fetchAppointmentsRT(barbero, dateISO){
  const path = `appointments/${barbero}/${dateISO}`;
  const snap = await get(child(ref(db), path));
  const arr = [];
  if(snap.exists()){
    const val = snap.val();
    for(const key of Object.keys(val)){
      const a = val[key];
      a.startMinutes = Number(a.startMinutes);
      a.durationMinutes = Number(a.durationMinutes);
      a.endMinutes = Number(a.endMinutes || (a.startMinutes + a.durationMinutes));
      arr.push(a);
    }
  }
  return arr.sort((a,b)=>a.startMinutes - b.startMinutes);
}

function buildOccupied(appts){
  const ivs = appts.map(a=>({start:a.startMinutes, end:a.endMinutes})).sort((a,b)=>a.start-b.start);
  const merged = [];
  for(const x of ivs){
    if(!merged.length || x.start > merged[merged.length-1].end){
      merged.push({...x});
    } else {
      merged[merged.length-1].end = Math.max(merged[merged.length-1].end, x.end);
    }
  }
  return merged;
}

function generateCandidateStarts(duration){
  const out = [];
  for(let t = OPEN_MIN; t + duration <= CLOSE_MIN; t += duration){
    out.push(t);
  }
  return out;
}

function isConflict(s,e,occupied){
  return occupied.some(iv => s < iv.end && e > iv.start);
}

/* ------------------------ REFRESCAR DISPONIBILIDAD ------------------------ */
async function refreshAvailability(){
  const service = servicioEl.value;
  const duration = parseDuration();

  summaryService.textContent = service || '-';
  summaryDuration.textContent = duration || '-';
  summaryPrice.textContent = parsePrice() ? `$${parsePrice().toLocaleString('es-CO')}` : '-';

  const barbero = barberoEl.value;
  const dateVal = fechaEl.value;

  availableList.innerHTML = '';
  slotsBox.innerHTML = '';
  horaSelect.innerHTML = '<option value="">Selecciona hora...</option>';

  if(!service || !duration){
    availableList.innerHTML = 'Selecciona un servicio para ver sugerencias.';
    slotsBox.textContent = 'Sin datos.';
    return;
  }

  const candidates = generateCandidateStarts(duration);

  // Modo sugerencias
  if(!barbero || !dateVal){
    availableList.innerHTML = 'Sugerencias disponibles';
    candidates.forEach(s=>{
      const div = document.createElement('div');
      div.className = 'slot';
      div.textContent = `${minutesToShortAmPm(s)} ‚Äî ${duration} min`;
      div.onclick = ()=>{
        horaSelect.value=s;
        document.querySelectorAll('.slot').forEach(x=>x.classList.remove('selected'));
        div.classList.add('selected');
      }
      slotsBox.appendChild(div);
      const opt = document.createElement('option');
      opt.value=s;
      opt.textContent=minutesToShortAmPm(s);
      horaSelect.appendChild(opt);
    });
    return;
  }

  // Modo disponibilidad real
  availableList.innerHTML = 'Cargando disponibilidad‚Ä¶ <span class="loader"></span>';

  try{
    const appts = await fetchAppointmentsRT(barbero, dateVal);
    const occupied = buildOccupied(appts);

    availableList.innerHTML = `Disponibilidad para <strong>${barbero}</strong>`;

    let any=false;
    candidates.forEach(s=>{
      const e=s+duration;
      const div=document.createElement('div');
      div.className='slot';

      if(isConflict(s,e,occupied)){
        div.classList.add('busy');
        div.textContent=`${minutesToShortAmPm(s)} ‚Äî Ocupado`;
        slotsBox.appendChild(div);
        return;
      }

      any=true;
      div.textContent=minutesToShortAmPm(s);
      div.onclick=()=>{
        horaSelect.value=s;
        document.querySelectorAll('.slot').forEach(x=>x.classList.remove('selected'));
        div.classList.add('selected');
      }
      slotsBox.appendChild(div);

      const opt=document.createElement('option');
      opt.value=s;
      opt.textContent=minutesToShortAmPm(s);
      horaSelect.appendChild(opt);
    });

    if(!any){
      slotsBox.innerHTML='<div class="muted">No hay horas libres.</div>';
    }

  }catch(err){
    console.error(err);
    showToast("Error cargando disponibilidad.","error");
  }
}

/* CAMBIOS QUE REFRESCAN DISPONIBILIDAD */
servicioEl.addEventListener('change', refreshAvailability);
barberoEl.addEventListener('change', refreshAvailability);
fechaEl.addEventListener('change', refreshAvailability);


/* ------------------------ BOT√ìN LIMPIAR ------------------------ */
btnLimpiar.addEventListener('click',()=>{
  document.getElementById('nombre').value='';
  document.getElementById('apellido').value='';
  document.getElementById('telefono').value='';
  document.getElementById('email').value='';
  servicioEl.value='';
  barberoEl.value='';
  fechaEl.value='';
  horaSelect.innerHTML='<option value="">Selecciona hora...</option>';
  availableList.innerHTML='Selecciona servicio para ver sugerencias‚Ä¶';
  slotsBox.innerHTML='';

  summaryService.textContent='-';
  summaryDuration.textContent='-';
  summaryPrice.textContent='-';
  resumenCita.style.display='none';

  showToast("Formulario limpiado.","success");
});


/* ------------------------ GUARDAR CITA ------------------------ */
let submitting=false;

btnGuardar.addEventListener('click',async()=>{

  if(submitting) return;

  const nombre = document.getElementById('nombre').value.trim();
  const apellido = document.getElementById('apellido').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const email = document.getElementById('email').value.trim();
  const barbero = barberoEl.value;
  const servicio = servicioEl.value;
  const duration = parseDuration();
  const price = parsePrice();
  const dateVal = fechaEl.value;
  const startMinutes = Number(horaSelect.value);

  /* ---------- VALIDACIONES APPLE STYLE ---------- */
  if(!validateName(nombre)) return showToast("Nombre inv√°lido. Solo letras, m√≠nimo 2 caracteres.","error");
  if(!validateName(apellido)) return showToast("Apellido inv√°lido.","error");
  if(!validatePhoneStrict(telefono)) return showToast("N√∫mero inv√°lido. Formato colombiano requerido.","error");
  if(!validateEmail(email)) return showToast("Correo inv√°lido.","error");
  if(!barbero) return showToast("Selecciona un barbero.","error");
  if(!servicio) return showToast("Selecciona un servicio.","error");
  if(!validateDate(dateVal)) return showToast("Fecha inv√°lida.","error");
  if(!validateHour(startMinutes,duration)) return showToast("Hora fuera de horario permitido.","error");

  submitting=true;
  btnGuardar.disabled=true;
  status.innerHTML='<span class="loader"></span>';

  /* ---------- VERIFICAR DISPONIBILIDAD EN FIREBASE ---------- */
  try{
    const appts = await fetchAppointmentsRT(barbero,dateVal);
    const occupied = buildOccupied(appts);
    const endMinutes = startMinutes + duration;

    if(isConflict(startMinutes,endMinutes,occupied)){
      showToast("La hora ya no est√° disponible.","error");
      submitting=false;
      btnGuardar.disabled=false;
      status.innerHTML='';
      return;
    }

    /* ---------- ESCRITURA SEGURA CON TRANSACTION ---------- */
    const parentPath = `appointments/${barbero}/${dateVal}`;
    const parentRef = ref(db,parentPath);

    await runTransaction(parentRef,(current)=>{
      if(current===null) current={};
      const existing = Object.values(current).map(x=>({
        start:Number(x.startMinutes),
        end:Number(x.endMinutes)
      }));

      for(const iv of existing){
        if(startMinutes < iv.end && endMinutes > iv.start){
          throw new Error("CONFLICT");
        }
      }

      current[startMinutes] = {
        nombre:`${nombre} ${apellido}`,
        telefono,
        email,
        barbero,
        servicio,
        durationMinutes:duration,
        startMinutes,
        endMinutes,
        date:dateVal,
        priceCOP:price,
        createdAt:Date.now()
      };

      return current;
    });

    /* ---------- RESUMEN ---------- */
    resNombre.textContent = `${nombre} ${apellido}`;
    resBarbero.textContent = barbero;
    resServicio.textContent = servicio;
    resFecha.textContent = dateVal;
    resHora.textContent = minutesToShortAmPm(startMinutes);
    resumenCita.style.display='block';

    const horaNice = minutesToAmPmWithSpace(startMinutes);

    /* ---------- WhatsApp ---------- */
    const msg = `
üíà *NUEVA RESERVA* üíà

üë§ Cliente: ${nombre} ${apellido}
üìû Tel√©fono: ${telefono}
üíá Servicio: ${servicio}
‚è± Duraci√≥n: ${duration} min
üí≤ Precio: $${price.toLocaleString('es-CO')}

üßî Barbero: ${barbero}
üìÖ Fecha: ${dateVal}
‚è∞ Hora: ${horaNice}

‚ú® Gracias por agendar en LA ZONA DEL BARBERO.
    `;

    const phoneDest = "573233489369";
    whatsappBtn.href = `https://wa.me/${phoneDest}?text=${encodeURIComponent(msg)}`;
    window.open(`https://wa.me/${phoneDest}?text=${encodeURIComponent(msg)}`,"_blank");

    showToast("Cita guardada correctamente.","success");

    await refreshAvailability();

  } catch(err){
    console.error(err);
    if(String(err).includes("CONFLICT")){
      showToast("La hora seleccionada ya est√° ocupada.","error");
    } else {
      showToast("Error guardando la cita.","error");
    }
  }

  submitting=false;
  btnGuardar.disabled=false;
  status.innerHTML='';
});

/* ------------------------ INICIAL ------------------------ */
refreshAvailability();

</script>
</body>
</html>
