<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA ZONA DEL BARBERO | Agenda tu Cita</title>
    <!-- Carga de Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Fuentes y Estilos -->
    <style>
        /* Usando Inter como fuente principal */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Fondo gris oscuro/negro */
            color: #f3f4f6; /* Texto blanco/gris claro */
        }
        .card {
            background-color: #2c2c2c; /* Fondo de tarjeta gris oscuro */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            border: 1px solid #4a4a4a; /* Borde sutil */
        }
        .btn-primary {
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #5a5a5a;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #4a4a4a;
            border-color: #ffffff;
        }
        .input-style, select {
            background-color: #1a1a1a;
            color: #f3f4f6;
            border-color: #5a5a5a;
        }
        /* Estilo para el calendario (fecha) */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Hace que el icono de calendario se vea blanco */
        }

        /* Asegurar que los selects que no sean 'hora' no estén disabled */
        #barbero, #servicio, #fecha {
            pointer-events: auto !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="card w-full max-w-xl rounded-xl p-6 md:p-10">
        <h1 class="text-4xl font-bold text-center mb-2 tracking-wider text-white">LA ZONA DEL BARBERO</h1>
        <p class="text-center text-gray-400 mb-8">Agenda tu Próxima Cita con Estilo</p>

        <form id="bookingForm" class="space-y-6">
            <!-- Sección de Datos del Cliente -->
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-gray-200">1. Tus Datos</h2>
            
            <div>
                <label for="nombre" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label>
                <input type="text" id="nombre" name="nombre" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>
            <div>
                <label for="apellido" class="block text-sm font-medium text-gray-300 mb-1">Apellido</label>
                <input type="text" id="apellido" name="apellido" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>
            <div>
                <label for="telefono" class="block text-sm font-medium text-gray-300 mb-1">Número de Teléfono (Ej: 3233489369)</label>
                <input type="tel" id="telefono" name="telefono" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" pattern="[0-9]{10}" title="Debe contener 10 dígitos numéricos." required>
            </div>
            <div>
                <label for="correo" class="block text-sm font-medium text-gray-300 mb-1">Correo Electrónico</label>
                <input type="email" id="correo" name="correo" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>

            <!-- Sección de Barbero y Servicio -->
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 pt-4 text-gray-200">2. Barbero y Servicio</h2>

            <div>
                <label for="barbero" class="block text-sm font-medium text-gray-300 mb-1">Barbero</label>
                <select id="barbero" name="barbero" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500 appearance-none" required>
                    <option value="" disabled selected>Selecciona un Barbero</option>
                    <!-- Opciones de barberos cargadas en JS -->
                </select>
            </div>

            <div>
                <label for="servicio" class="block text-sm font-medium text-gray-300 mb-1">Servicio</label>
                <select id="servicio" name="servicio" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500 appearance-none" required>
                    <option value="" disabled selected>Selecciona un Servicio</option>
                    <!-- Opciones de servicios cargadas en JS -->
                </select>
            </div>

            <div id="precio-display" class="text-lg font-bold text-center text-gray-200 mt-4 mb-4 hidden">
                Precio: <span id="precio-valor" class="text-white"></span>
            </div>

            <!-- Sección de Fecha y Hora -->
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 pt-4 text-gray-200">3. Programar Fecha y Hora</h2>

            <div>
                <label for="fecha" class="block text-sm font-medium text-gray-300 mb-1">Programar Fecha</label>
                <input type="date" id="fecha" name="fecha" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500" required>
            </div>

            <div>
                <label for="hora" class="block text-sm font-medium text-gray-300 mb-1">Programar Hora</label>
                <select id="hora" name="hora" class="input-style w-full p-3 rounded-lg border focus:ring-gray-500 focus:border-gray-500 appearance-none" required disabled>
                    <option value="" disabled selected>Primero selecciona Barbero, Servicio y Fecha</option>
                </select>
                <p id="loading-message" class="text-sm text-gray-400 mt-2 hidden">Cargando disponibilidad...</p>
            </div>

            <!-- Mensajes del sistema (Ahora invisibles en la interfaz, solo en la consola si hay un problema grave) -->
            <!-- La funcionalidad de displayMessage se mantiene en JS pero no se renderiza aquí -->
            <div id="message-box" class="hidden"></div> 

            <button type="submit" id="submit-btn" class="btn-primary w-full p-3 rounded-lg text-lg font-semibold hover:bg-gray-700 transition duration-150 ease-in-out" disabled>
                Confirmar Cita y Notificar
            </button>
        </form>
    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Entorno (Fija del Usuario) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
            authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
            projectId: "lazonadelbarbero-b4e75",
            storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
            messagingSenderId: "251180096928",
            appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
            measurementId: "G-G4YL7M4Z00"
        };
        
        // Uso de variables de entorno, con fallback a la configuración fija
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Número de WhatsApp del negocio
        const WA_PHONE_NUMBER = '573233489369';
        
        // --- Constantes de Servicios y Barberos ---
        const SERVICES = [
            { id: 'corte', name: 'Corte', price: 18000, duration: 30 },
            { id: 'corte_ceja', name: 'Corte + Ceja', price: 22000, duration: 40 },
            { id: 'corte_ceja_barba', name: 'Corte + Ceja + Barba', price: 25000, duration: 60 },
            { id: 'corte_limpieza', name: 'Corte + Limpieza Facial', price: 65000, duration: 150 }
        ];

        const BARBERS = [
            { id: 'dylan', name: 'Dylan' },
            { id: 'santiago', name: 'Santiago' },
            { id: 'alejandro', name: 'Alejandro' },
            { id: 'leo', name: 'Leo' },
        ];
        
        // Horario de apertura y cierre en minutos desde medianoche (10:00 AM a 8:40 PM)
        const OPEN_TIME = 10 * 60; 
        const CLOSE_TIME = (20 * 60) + 40; 

        // --- Variables de Estado y Elementos del DOM ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let activeSnapshotUnsubscribe = null;
        let bookedAppointments = [];

        const form = document.getElementById('bookingForm');
        const barberoSelect = document.getElementById('barbero');
        const servicioSelect = document.getElementById('servicio');
        const fechaInput = document.getElementById('fecha');
        const horaSelect = document.getElementById('hora');
        const submitBtn = document.getElementById('submit-btn');
        const messageBox = document.getElementById('message-box'); // Se mantiene para llamadas internas
        const loadingMessage = document.getElementById('loading-message');
        const precioValor = document.getElementById('precio-valor');
        const precioDisplay = document.getElementById('precio-display');
        
        // --- Funciones de Utilidad ---

        /** Formatea un número como moneda colombiana (COP). */
        const formatCOP = (value) => {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        };

        /** Convierte un número de minutos (desde medianoche) a formato HH:MM (24h). */
        const minutesToTime = (totalMinutes) => {
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };

        /** * Muestra un mensaje en la interfaz (AHORA SOLO IMPRIME EN CONSOLA). 
         * Se mantiene la estructura por si se quiere re-implementar una UI de mensajes.
         */
        const displayMessage = (message, type) => {
            if (type === 'error') {
                 console.error(`[ERROR AGENDAMIENTO] ${message}`);
            } else {
                 console.log(`[INFO AGENDAMIENTO] ${message}`);
            }
        };

        /**
         * Valida si un bloque de tiempo está disponible (no solapamiento y dentro de horario).
         */
        const isSlotAvailable = (startMin, duration) => {
            const endMin = startMin + duration;

            if (endMin > CLOSE_TIME) {
                return false;
            }

            for (const appointment of bookedAppointments) {
                const bookedStart = appointment.startMinutes;
                const bookedEnd = appointment.endMinutes;

                // Detectar solapamiento: El nuevo slot empieza antes de que termine el agendado O
                // El nuevo slot termina después de que empieza el agendado.
                const overlaps = (startMin < bookedEnd && endMin > bookedStart);
                
                if (overlaps) {
                    return false; 
                }
            }
            return true;
        };

        /**
         * Genera la lista de horas disponibles basada en las citas agendadas y el servicio.
         */
        const generateTimeSlots = () => {
            horaSelect.innerHTML = '<option value="" disabled selected>Selecciona una Hora</option>';
            horaSelect.disabled = true;
            submitBtn.disabled = !form.checkValidity() || horaSelect.value === '';

            const selectedServiceId = servicioSelect.value;
            const selectedService = SERVICES.find(s => s.id === selectedServiceId);

            if (!selectedService || !bookedAppointments) return;

            const duration = selectedService.duration;
            const availableSlots = [];

            // Iterar cada 10 minutos
            for (let startMin = OPEN_TIME; startMin < CLOSE_TIME; startMin += 10) {
                
                if (isSlotAvailable(startMin, duration)) {
                    const timeString = minutesToTime(startMin);
                    
                    if (startMin + duration <= CLOSE_TIME) {
                        availableSlots.push({ time: timeString, endMinutes: startMin + duration });
                    }
                }
            }

            if (availableSlots.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No hay horas disponibles para este servicio/día.';
                option.disabled = true;
                horaSelect.appendChild(option);
            } else {
                availableSlots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.time;
                    option.textContent = `${slot.time} - (Finaliza ${minutesToTime(slot.endMinutes)})`;
                    horaSelect.appendChild(option);
                });
                horaSelect.disabled = false;
            }
            // Re-evaluar el estado del botón después de generar los slots
            submitBtn.disabled = !form.checkValidity() || horaSelect.value === '';
        };

        // --- Lógica de Firebase y Carga de Datos ---
        
        /** Ruta a la colección de citas para el Barbero y Fecha seleccionados. */
        const getAppointmentsCollectionPath = (barberId, dateString) => {
            return `artifacts/${appId}/public/data/barber_appointments/${barberId}/${dateString}`;
        };

        /** Inicia el listener de Firestore para la disponibilidad. */
        const startAvailabilityListener = () => {
            // Guard clause: Evitar correr si no está listo o faltan campos esenciales
            if (!isAuthReady || !db || !barberoSelect.value || !servicioSelect.value || !fechaInput.value) {
                // Si falta autenticación o campos, simplemente limpia y espera
                bookedAppointments = [];
                generateTimeSlots();
                if (activeSnapshotUnsubscribe) {
                    activeSnapshotUnsubscribe();
                    activeSnapshotUnsubscribe = null;
                }
                return;
            }

            // Limpiar listener anterior
            if (activeSnapshotUnsubscribe) {
                activeSnapshotUnsubscribe();
                activeSnapshotUnsubscribe = null;
            }

            const barberId = barberoSelect.value;
            const dateString = fechaInput.value;

            loadingMessage.classList.remove('hidden');
            horaSelect.disabled = true;

            const collectionPath = getAppointmentsCollectionPath(barberId, dateString);
            const q = collection(db, collectionPath);
            
            activeSnapshotUnsubscribe = onSnapshot(q, (snapshot) => {
                bookedAppointments = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    bookedAppointments.push({
                        id: doc.id,
                        startMinutes: data.startMinutes,
                        endMinutes: data.endMinutes,
                        duration: data.duration,
                        serviceId: data.serviceId
                    });
                });

                // Ordenar para la lógica de solapamiento
                bookedAppointments.sort((a, b) => a.startMinutes - b.startMinutes);
                
                loadingMessage.classList.add('hidden');
                generateTimeSlots();

            }, (error) => {
                console.error("Error al cargar citas de Firestore. Asegúrate de que las reglas de seguridad son correctas.", error);
                loadingMessage.classList.add('hidden');
                // Ya no mostramos la alerta roja en la UI, solo en la consola.
            });
        };

        /** Inicializa la app de Firebase y la autenticación. */
        const initializeFirebase = async () => {
            try {
                // 1. Inicializar App
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 2. Autenticación
                const authReadyPromise = new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); 
                        try {
                            if (!user) {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                            isAuthReady = true;
                            displayMessage("Conexión con la base de datos establecida.", 'info'); // Solo en consola
                            resolve();
                        } catch (authError) {
                            console.error("Error de autenticación de Firebase:", authError);
                            isAuthReady = false;
                            reject(authError);
                        }
                    }, (error) => {
                        reject(error);
                    });
                });

                await authReadyPromise;
                
            } catch (error) {
                console.error("Error grave: No se pudo conectar a Firebase. Revisa la configuración.", error);
                isAuthReady = false;
            }
        };

        // --- Carga de Opciones Estáticas (Barberos y Servicios) ---

        const loadStaticOptions = () => {
            // Cargar Barberos
            BARBERS.forEach(barber => {
                const option = document.createElement('option');
                option.value = barber.id;
                option.textContent = barber.name;
                barberoSelect.appendChild(option);
            });

            // Cargar Servicios
            SERVICES.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name} (${formatCOP(service.price)})`;
                servicioSelect.appendChild(option);
            });

            // Establecer fecha mínima como hoy
            const today = new Date().toISOString().split('T')[0];
            fechaInput.min = today;
            fechaInput.value = today; // Inicializar con la fecha de hoy
            
            displayMessage("Opciones de Barbero/Servicio cargadas correctamente.", 'info'); // Solo en consola
        };

        // --- Handlers de Eventos ---
        
        const handleFormChange = (event) => {
            // Activar/Desactivar el botón de envío
            submitBtn.disabled = !form.checkValidity() || horaSelect.value === '';
            
            // Si cambian Barbero, Servicio o Fecha, actualizar disponibilidad
            if (event.ta
