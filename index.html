<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LA ZONA DEL BARBERO — Agendamiento</title>
  <style>
    :root{
      --bg:#06070a; --card:#0e1115; --muted:#9aa0a6; --line:#1e252b;
      --text:#e6eef3; 
      --accent:#f6c358; /* Color de acento: dorado/amarillo */
      --accent-2:#7be3a8; /* Color secundario: verde */
      --glass:rgba(255,255,255,0.03);
      --danger:#ef6b6b;
      --good:#35d19b; 
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    
    /* MODIFICADO: Fondo base negro sólido */
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background-color:#000000;color:var(--text);-webkit-font-smoothing:antialiased}

    /* --- LOGO WATERMARK (OPACIDAD Y TAMAÑO AUMENTADOS) --- */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('1000070893.png') no-repeat center center;
      background-size: 700px; /* Aumentado */
      opacity: 0.05; /* Aumentado */
      pointer-events: none;
      z-index: -1;
    }
    /* --- FIN LOGO WATERMARK --- */

    .container{max-width:480px;margin:auto;padding:20px;position:relative}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:25px;border-radius:var(--radius);border:1px solid var(--line);box-shadow:0 6px 30px rgba(0,0,0,0.6);margin-bottom:20px}
    h1{font-size:24px;text-align:center;color:var(--text)}
    h2{font-size:18px;margin-top:0;color:var(--accent)}
    h3{font-size:16px;margin-top:0;color:var(--accent-2)}
    
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;margin-top:15px}
    input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:var(--card);color:var(--text);font-size:15px}
    input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1)}

    /* Botones */
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071018;border:none;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:0 8px 20px rgba(123,227,168,0.06);width:100%;margin-top:20px}
    button.primary:disabled{opacity:0.6;cursor:not-allowed;box-shadow:none}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--line);padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700;width:49%}
    button.secondary:disabled{opacity:0.3;cursor:not-allowed}

    /* Stepper / Tabs */
    .stepper{display:flex;justify-content:center;margin-bottom:20px}
    .step{width:12px;height:12px;border-radius:50%;background:var(--line);margin:0 5px;transition:background-color .3s}
    .step.active{background:var(--accent-2)}
    .tabs-container{overflow:hidden;position:relative}
    .tabs-content{display:flex;transition:transform .3s ease-out}
    .tab-pane{flex-shrink:0;width:100%;padding:0}

    /* Selector de Servicios */
    .service-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .service-item{background:var(--card);padding:15px;border-radius:10px;border:2px solid var(--line);cursor:pointer;transition:all .2s;text-align:center}
    .service-item:hover{background:var(--glass)}
    .service-item.selected{border-color:var(--accent-2);background:rgba(123,227,168,0.1);box-shadow:0 0 10px rgba(123,227,168,0.5)}
    .service-item h4{margin:0 0 5px 0;font-size:14px;color:var(--text)}
    .service-item p{margin:0;font-size:11px;color:var(--muted)}

    /* Selector de Barberos */
    .barber-grid{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px;margin-top:10px}
    .barber-item{flex-shrink:0;width:120px;text-align:center;padding:10px;border-radius:10px;border:2px solid var(--line);cursor:pointer;transition:all .2s;background:var(--card)}
    .barber-item:hover{background:var(--glass)}
    .barber-item.selected{border-color:var(--accent);background:rgba(246,195,88,0.1);box-shadow:0 0 10px rgba(246,195,88,0.5)}
    .barber-item img{width:60px;height:60px;border-radius:50%;object-fit:cover;margin-bottom:5px}
    .barber-item h4{margin:0;font-size:14px;color:var(--text)}
    
    /* Selector de Horarios */
    .slots-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:15px;max-height:250px;overflow-y:auto;padding-right:5px}
    .slot-item{background:var(--card);padding:10px 5px;border-radius:8px;border:1px solid var(--line);text-align:center;font-size:14px;cursor:pointer;transition:all .2s;white-space:nowrap}
    .slot-item:hover:not(.taken):not(.past):not(.absent){background:var(--glass)}
    .slot-item.selected{border-color:var(--accent-2);background:rgba(123,227,168,0.2);box-shadow:0 0 8px rgba(123,227,168,0.5);font-weight:700}
    
    /* Estados de Horario */
    .slot-item.taken{background:rgba(255,255,255,0.05);color:var(--muted);cursor:not-allowed;opacity:0.6;border-style:dashed;}
    
    /* NUEVOS ESTILOS PARA AUSENCIA Y HORA PASADA */
    .slot-item.absent {
        background-color: rgba(239, 107, 107, 0.2) !important; /* Semi-transparent danger color */
        color: var(--danger) !important;
        border: 1px solid var(--danger);
        cursor: not-allowed;
        opacity: 0.8;
    }
    .slot-item.past {
        background-color: rgba(154, 160, 166, 0.1) !important; /* Muted color for past */
        color: var(--muted) !important;
        border: 1px solid var(--line);
        cursor: not-allowed;
        opacity: 0.4;
    }

    /* Mensajes de feedback */
    .message{padding:10px;border-radius:10px;margin-top:10px;font-size:14px;display:none;margin-bottom:10px;text-align:center} 
    .success{background:rgba(53, 209, 155, 0.1);color:var(--good);border:1px solid var(--good)}
    .error{background:rgba(239, 107, 107, 0.1);color:var(--danger);border:1px solid var(--danger)}
    .loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid var(--line);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <h1><span style="color:var(--accent)">LA ZONA</span> DEL BARBERO</h1>
    <div class="stepper">
      <div class="step active"></div>
      <div class="step"></div>
      <div class="step"></div>
      <div class="step"></div>
    </div>
    
    <div class="tabs-container">
      <div class="tabs-content">

        <div class="tab-pane" id="tab1">
          <div class="card">
            <h2>Paso 1: Selecciona tu servicio</h2>
            <div id="serviceGrid" class="service-grid">
              <p style="text-align:center;color:var(--muted)">Cargando servicios...</p>
            </div>
            <p id="serviceInfo" style="margin-top:15px;font-size:14px;color:var(--accent-2);text-align:center;display:none;">Servicio seleccionado: <strong id="selectedService"></strong> (<strong id="selectedDuration"></strong> min)</p>
          </div>
        </div>

        <div class="tab-pane" id="tab2">
          <div class="card">
            <h2>Paso 2: Elige a tu barbero</h2>
            <div id="barberGrid" class="barber-grid">
              <p style="text-align:center;color:var(--muted)">Cargando barberos...</p>
            </div>
            <p id="barberInfo" style="margin-top:15px;font-size:14px;color:var(--accent);text-align:center;display:none;">Barbero seleccionado: <strong id="selectedBarber"></strong></p>
          </div>
        </div>

        <div class="tab-pane" id="tab3">
          <div class="card">
            <h2>Paso 3: Fecha y Hora</h2>
            <label for="dateSelected">Fecha:</label>
            <input type="date" id="dateSelected">

            <p style="margin-top:15px;font-size:14px;color:var(--muted)">Horarios disponibles (duración: <strong id="currentDurationDisplay"></strong> min):</p>
            <div id="timeSlots" class="slots-container">
              <p style="text-align:center;color:var(--muted)">Selecciona una fecha y un barbero.</p>
            </div>
            <p id="timeInfo" style="margin-top:15px;font-size:14px;color:var(--accent-2);text-align:center;display:none;">Hora seleccionada: <strong id="selectedTime"></strong></p>
          </div>
        </div>

        <div class="tab-pane" id="tab4">
          <div class="card">
            <h2>Paso 4: Tus Datos</h2>
            <div id="submitMessage" class="message"></div>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label for="nombre">Nombre *</label>
                    <input type="text" id="nombre" placeholder="Tu nombre">
                </div>
                <div style="flex:1;">
                    <label for="apellido">Apellido *</label>
                    <input type="text" id="apellido" placeholder="Tu apellido">
                </div>
            </div>

            <label for="telefono">Teléfono (WhatsApp) *</label>
            <input type="tel" id="telefono" placeholder="Ej: 573101234567">
            <p style="font-size:11px;color:var(--muted);margin-top:5px;">El formato debe incluir el código de país (Ej: 57 para Colombia).</p>

            <h3>Resumen de la Cita</h3>
            <p style="font-size:14px;margin-top:10px;line-height:1.4">
                Servicio: <strong id="summaryService"></strong> (<strong id="summaryDuration"></strong> min)<br>
                Barbero: <strong id="summaryBarber"></strong><br>
                Fecha y Hora: <strong id="summaryDateTime"></strong>
            </p>

            <button class="primary" id="btnConfirmAppointment">Confirmar Cita</button>
            <p style="text-align:center;font-size:12px;color:var(--muted);margin-top:15px;">Recibirás un mensaje de confirmación por WhatsApp.</p>
          </div>
        </div>

      </div>
    </div>
    
    <div style="display:flex;justify-content:space-between;gap:10px;margin-top:10px">
        <button class="secondary" id="prevTab" disabled>Anterior</button>
        <button class="primary" id="nextTab">Siguiente</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, push, get, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // Firebase config (DEBE SER LA MISMA que en el admin.html)
    const firebaseConfig = {
      apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
      authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
      databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
      projectId: "lazonadelbarbero-b4e75",
      storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
      messagingSenderId: "251180096928",
      appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
      measurementId: "G-G4YL7M4Z00"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- CONFIGURATION ---
    const SERVICES = [
      { id: 'corte', name: 'Corte Clásico', duration: 40, price: 20000 },
      { id: 'barba', name: 'Arreglo de Barba', duration: 30, price: 15000 },
      { id: 'corte_barba', name: 'Corte + Barba', duration: 70, price: 35000 },
      { id: 'cejas', name: 'Diseño de Cejas', duration: 15, price: 10000 },
      { id: 'kids', name: 'Corte Infantil', duration: 30, price: 18000 }
    ];

    const BARBERS = [
        { id: 'Dilan', name: 'Dilan', img: 'barber_dilan.jpg' },
        { id: 'Alejandro', name: 'Alejandro', img: 'barber_alejo.jpg' },
        { id: 'Leonardo', name: 'Leonardo', img: 'barber_leo.jpg' },
        { id: 'Santiago', name: 'Santiago', img: 'barber_santi.jpg' }
    ];
    
    // Horario de apertura y cierre en minutos desde la medianoche
    const OPENING_MINUTES = 8 * 60; // 8:00 AM
    const CLOSING_MINUTES = 21 * 60; // 9:00 PM

    // --- GLOBAL STATE ---
    let state = {
      service: null,
      barber: null,
      date: null,
      time: null, // time in minutes from midnight
      name: '',
      phone: ''
    };
    
    let appointmentsCache = []; // Cache para guardar las citas del barbero seleccionado
    let allAbsencesCache = { days: {}, hours: {} }; // NEW: Cache para guardar las ausencias del barbero seleccionado
    
    // --- DOM Elements ---
    const stepElements = document.querySelectorAll('.step');
    const tabsContent = document.querySelector('.tabs-content');
    const prevTab = document.getElementById('prevTab');
    const nextTab = document.getElementById('nextTab');
    
    // Tab 1: Service
    const serviceGrid = document.getElementById('serviceGrid');
    const selectedServiceEl = document.getElementById('selectedService');
    const selectedDurationEl = document.getElementById('selectedDuration');

    // Tab 2: Barber
    const barberGrid = document.getElementById('barberGrid');
    const selectedBarberEl = document.getElementById('selectedBarber');

    // Tab 3: Date & Time
    const dateSelectedEl = document.getElementById('dateSelected');
    const currentDurationDisplay = document.getElementById('currentDurationDisplay');
    const timeSlotsEl = document.getElementById('timeSlots');
    const selectedTimeEl = document.getElementById('selectedTime');

    // Tab 4: Contact & Summary
    const nombreInput = document.getElementById('nombre');
    const apellidoInput = document.getElementById('apellido');
    const telefonoInput = document.getElementById('telefono');
    const summaryService = document.getElementById('summaryService');
    const summaryDuration = document.getElementById('summaryDuration');
    const summaryBarber = document.getElementById('summaryBarber');
    const summaryDateTime = document.getElementById('summaryDateTime');
    const btnConfirmAppointment = document.getElementById('btnConfirmAppointment');
    const submitMessageEl = document.getElementById('submitMessage');


    // --- UTILS ---
    function minutesToAmPm(m) {
      let hh = Math.floor(m / 60);
      const mm = String(m % 60).padStart(2, '0');
      const ampm = hh >= 12 ? 'PM' : 'AM';
      hh = hh % 12;
      if (hh === 0) hh = 12;
      return `${hh}:${mm} ${ampm}`;
    }

    function showMessage(element, type, text) {
      element.classList.remove('success', 'error');
      element.classList.add(type);
      element.textContent = text;
      element.style.display = 'block';
    }
    
    function hideMessage(element) {
        element.style.display = 'none';
    }
    
    // Convierte "HH:MM" a minutos desde la medianoche
    function timeToMinutes(timeStr) {
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }


    // --- NEW: ABSENCE LOGIC (PORTED FROM ADMIN PANEL) ---
    /**
     * Verifica si un periodo de tiempo (cita) se solapa con una ausencia programada del barbero.
     * @param {string} dateISO - Fecha ISO de la cita.
     * @param {number} startMinutes - Minutos de inicio de la cita.
     * @param {number} endMinutes - Minutos de fin de la cita.
     * @returns {boolean} True si el barbero está ausente en ese periodo.
     */
    function checkBarberAbsence(dateISO, startMinutes, endMinutes) {
        const days = allAbsencesCache.days || {};
        const hours = allAbsencesCache.hours || {};
        
        // 1. Verificar Ausencia por Días Completos
        for (const startDate in days) {
            const period = days[startDate];
            // Si la fecha de la cita es >= fecha inicio Y <= fecha fin
            if (dateISO >= startDate && dateISO <= period.endDate) {
                return true; // Ausente por el día completo
            }
        }
        
        // 2. Verificar Ausencia por Horas
        const hourlyAbsencesOnDate = hours[dateISO];
        if (hourlyAbsencesOnDate) {
            for (const startMinKey in hourlyAbsencesOnDate) {
                const period = hourlyAbsencesOnDate[startMinKey];
                const absenceStart = Number(startMinKey);
                const absenceEnd = Number(period.endMinutes);

                // Revisa si la cita se solapa con el periodo de ausencia
                // Solapamiento: slot start < absence end AND slot end > absence start
                if (startMinutes < absenceEnd && endMinutes > absenceStart) {
                    return true; // Ausente durante el slot de tiempo
                }
            }
        }
        
        return false;
    }

    // --- FIREBASE DATA HANDLING ---

    // Helper para procesar la data de Firebase en un array ordenado
    function processSnapshot(snapshot) {
        const allAppointments = [];
        if (snapshot.exists()) {
            const datesData = snapshot.val();
            for (const dateISO in datesData) {
                const appointmentsOnDate = datesData[dateISO];
                for (const key in appointmentsOnDate) {
                    const appt = appointmentsOnDate[key];
                    if (!appt.completed) { // Solo consideramos citas no completadas
                        appt.dateISO = dateISO;
                        appt.id = key; 
                        appt.startMinutes = Number(appt.startMinutes);
                        appt.durationMinutes = Number(appt.durationMinutes);
                        allAppointments.push(appt);
                    }
                }
            }
        }
        return allAppointments;
    }

    /**
     * Carga las citas y las ausencias del barbero seleccionado.
     * @param {string} barberName - Nombre del barbero.
     */
    async function fetchBarberData(barberName) {
        if (!barberName) return;
        
        // 1. Fetch Absences (One-time fetch for current state)
        const absencesRef = ref(db, `unavailableDates/${barberName}`);
        try {
            const snapshot = await get(absencesRef);
            const data = snapshot.val() || { days: {}, hours: {} };
            allAbsencesCache = {
                days: data.days || {},
                hours: data.hours || {}
            };
        } catch (error) {
            console.error("Error fetching absences:", error);
            allAbsencesCache = { days: {}, hours: {} }; // Clear cache on error
        }
        
        // 2. Set up Appointment Listener (Real-time updates)
        const appointmentsRef = ref(db, `appointments/${barberName}`);
        onValue(appointmentsRef, (snapshot) => {
            appointmentsCache = processSnapshot(snapshot);
            updateTimeSlots(); // Refresca slots cada vez que hay un cambio en las citas O ausencias
        });
        
        // Llamada inicial a updateTimeSlots después de cargar las ausencias
        updateTimeSlots();
    }


    // --- UI/STATE CONTROL ---

    // Generación de Servicios
    function renderServices() {
      let html = '';
      SERVICES.forEach(service => {
        const isSelected = state.service && state.service.id === service.id;
        html += `
          <div class="service-item ${isSelected ? 'selected' : ''}" data-id="${service.id}" data-duration="${service.duration}" data-name="${service.name}">
            <h4>${service.name}</h4>
            <p>${service.duration} min</p>
          </div>
        `;
      });
      serviceGrid.innerHTML = html;
      
      // Attach listeners
      serviceGrid.querySelectorAll('.service-item').forEach(item => {
        item.addEventListener('click', handleServiceSelect);
      });

      // Show selected info on load
      if (state.service) {
        document.getElementById('serviceInfo').style.display = 'block';
      }
    }

    function handleServiceSelect(event) {
      const item = event.currentTarget;
      const id = item.dataset.id;
      const duration = parseInt(item.dataset.duration);
      const name = item.dataset.name;

      if (state.service && state.service.id === id) {
        // Deseleccionar
        state.service = null;
        item.classList.remove('selected');
        document.getElementById('serviceInfo').style.display = 'none';
      } else {
        // Seleccionar nuevo
        document.querySelectorAll('.service-item').forEach(i => i.classList.remove('selected'));
        item.classList.add('selected');
        state.service = { id, name, duration };
        selectedServiceEl.textContent = name;
        selectedDurationEl.textContent = duration;
        document.getElementById('serviceInfo').style.display = 'block';
        updateTimeSlots(); // Refresh slots if duration changes

        // Reset state for next steps if a different service is selected
        state.time = null;
        document.getElementById('timeInfo').style.display = 'none';
        updateSummary();
      }
    }

    // Generación de Barberos
    function renderBarbers() {
        let html = '';
        BARBERS.forEach(barber => {
            const isSelected = state.barber === barber.id;
            html += `
                <div class="barber-item ${isSelected ? 'selected' : ''}" data-id="${barber.id}">
                    <img src="${barber.img || 'barber_placeholder.jpg'}" alt="${barber.name}">
                    <h4>${barber.name}</h4>
                </div>
            `;
        });
        barberGrid.innerHTML = html;

        // Attach listeners
        barberGrid.querySelectorAll('.barber-item').forEach(item => {
            item.addEventListener('click', handleBarberSelect);
        });

        if (state.barber) {
            document.getElementById('barberInfo').style.display = 'block';
        }
    }

    function handleBarberSelect(event) {
        const item = event.currentTarget;
        const id = item.dataset.id;
        
        if (state.barber === id) {
            // Deseleccionar
            state.barber = null;
            item.classList.remove('selected');
            document.getElementById('barberInfo').style.display = 'none';
            appointmentsCache = []; // Clear cache
            allAbsencesCache = { days: {}, hours: {} }; // NEW: Clear absence cache
            updateTimeSlots();
        } else {
            // Seleccionar nuevo
            document.querySelectorAll('.barber-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            state.barber = id;
            selectedBarberEl.textContent = id;
            document.getElementById('barberInfo').style.display = 'block';
            
            // Load new barber's data
            fetchBarberData(id);

            // Reset time state for new barber
            state.time = null;
            document.getElementById('timeInfo').style.display = 'none';
            updateSummary();
        }
    }

    // Generación y Actualización de Slots
    function getAvailableTimeSlots(duration) {
      const slots = [];
      // Iterar en intervalos de 5 minutos (para ser más exactos)
      for (let start = OPENING_MINUTES; start <= CLOSING_MINUTES - duration; start += 5) {
        // Asegurarse de que el slot completo no exceda la hora de cierre
        if (start + duration <= CLOSING_MINUTES) {
          slots.push(start);
        }
      }
      return slots;
    }

    function updateTimeSlots() {
      const totalDuration = state.service ? state.service.duration : 0;
      const barberName = state.barber;
      const selectedDate = dateSelectedEl.value;

      currentDurationDisplay.textContent = totalDuration;
      timeSlotsEl.innerHTML = '';
      hideMessage(submitMessageEl);

      if (!barberName || !selectedDate || totalDuration === 0) {
        timeSlotsEl.innerHTML = `<p style="text-align:center;color:var(--muted)">Selecciona un Barbero, un Servicio y una Fecha.</p>`;
        nextTab.disabled = true;
        return;
      }

      const availableMinutes = getAvailableTimeSlots(totalDuration);
      
      // 1. Generar lista de slots ocupados (minutoInicio-minutoFin)
      const occupiedSlots = new Set();
      appointmentsCache
        .filter(appt => appt.dateISO === selectedDate)
        .forEach(appt => {
          const apptStart = appt.startMinutes;
          const apptEnd = appt.startMinutes + appt.durationMinutes;
          
          // Marcar todos los intervalos de 5 minutos dentro de la cita como ocupados
          for (let i = apptStart; i < apptEnd; i += 5) {
            occupiedSlots.add(`${i}-${i + totalDuration}`);
          }
        });

      const isToday = selectedDate === new Date().toISOString().split('T')[0];
      const nowMinutes = new Date().getHours() * 60 + new Date().getMinutes();
      
      // Verificar la regla del usuario: ¿Es hoy y son las 12:00 PM (720 min) o más tarde?
      const isPast12PMRuleActive = isToday && nowMinutes >= 720; 
      
      let slotsHTML = '';
      let availableCount = 0;

      availableMinutes.forEach(slotStart => {
        const slotEnd = slotStart + totalDuration;
        const timeKey = `${slotStart}-${slotEnd}`;
        const isTakenByAppointment = occupiedSlots.has(timeKey);
        
        // 1. NEW: Check for barber absence
        const isAbsent = checkBarberAbsence(selectedDate, slotStart, slotEnd);
        
        // 2. NEW: Check for the 12 PM past hours rule and general past time
        let isSlotDisabledByTime = false;
        
        if (isAbsent) {
            isSlotDisabledByTime = false; // Absence takes visual priority, but it is disabled
        }
        else if (isPast12PMRuleActive) {
             // Si son 12 PM o más tarde, deshabilitar si la hora de fin del slot ya pasó
             if (slotEnd <= nowMinutes) {
                isSlotDisabledByTime = true;
             }
        } else if (isToday) {
            // Si es hoy (y es antes de 12 PM), solo deshabilitar slots que ya estén en el pasado
            if (slotEnd <= nowMinutes) {
                isSlotDisabledByTime = true;
            }
        }
        
        // 3. Determine final disabled state
        const isDisabled = isTakenByAppointment || isAbsent || isSlotDisabledByTime;

        let slotClass = 'slot-item';
        let tooltip = '';
        
        if (isTakenByAppointment) {
            slotClass += ' taken';
            tooltip = 'Reservado';
        } else if (isAbsent) {
            slotClass += ' absent'; 
            tooltip = 'Barbero No Disponible';
        } else if (isSlotDisabledByTime) {
            slotClass += ' past'; 
            tooltip = 'Hora Pasada';
        } else {
            slotClass += ' available';
            availableCount++;
            tooltip = 'Disponible';
        }
        
        // Mantener slot seleccionado si corresponde
        if (state.time === slotStart && !isDisabled) {
            slotClass += ' selected';
        } else if (state.time === slotStart && isDisabled) {
            // Si el slot seleccionado se volvió no disponible, deseleccionarlo
            state.time = null;
            document.getElementById('timeInfo').style.display = 'none';
        }
        
        slotsHTML += `
          <div class="${slotClass}" data-minutes="${slotStart}" title="${tooltip}">
            ${minutesToAmPm(slotStart)}
          </div>
        `;
      });

      timeSlotsEl.innerHTML = slotsHTML;

      if (availableCount === 0) {
        timeSlotsEl.innerHTML = `<p style="text-align:center;color:var(--danger);font-weight:700;">No hay horarios disponibles para el servicio y barbero seleccionados en esta fecha.</p>`;
      }
      
      // Attach listeners to available slots
      timeSlotsEl.querySelectorAll('.available').forEach(item => {
        item.addEventListener('click', handleTimeSelect);
      });
      
      // Update next button state based on selections
      if (state.time) {
          nextTab.disabled = false;
          document.getElementById('timeInfo').style.display = 'block';
      } else {
          nextTab.disabled = true;
          document.getElementById('timeInfo').style.display = 'none';
      }
    }

    function handleTimeSelect(event) {
      const item = event.currentTarget;
      const minutes = parseInt(item.dataset.minutes);

      document.querySelectorAll('.slot-item').forEach(i => i.classList.remove('selected'));
      item.classList.add('selected');
      
      state.time = minutes;
      selectedTimeEl.textContent = minutesToAmPm(minutes);
      document.getElementById('timeInfo').style.display = 'block';

      updateSummary();
      nextTab.disabled = false;
    }

    function updateSummary() {
        summaryService.textContent = state.service ? state.service.name : 'N/A';
        summaryDuration.textContent = state.service ? state.service.duration : 'N/A';
        summaryBarber.textContent = state.barber || 'N/A';
        
        let dateTimeText = 'N/A';
        if (state.date && state.time !== null) {
            dateTimeText = `${state.date} a las ${minutesToAmPm(state.time)}`;
        }
        summaryDateTime.textContent = dateTimeText;
    }

    // --- NAVIGATION LOGIC ---
    let tabIndex = 0;
    const tabPanes = document.querySelectorAll('.tab-pane');

    function updateTabs() {
      tabPanes.forEach((pane, i) => pane.style.width = '100%'); // Ensure width is set
      tabsContent.style.transform = `translateX(-${tabIndex * 100}%)`;
      stepElements.forEach((s,i)=> s.classList.toggle('active', i === tabIndex));
      prevTab.disabled = tabIndex === 0;
      
      nextTab.textContent = tabIndex === tabPanes.length - 1 ? 'Confirmar' : 'Siguiente';
      nextTab.disabled = !checkCurrentTabValid(); // Check state for button

      // Focus the first relevant input for UX
      setTimeout(() => {
        if (tabIndex === 0) {
            // Nothing to focus
        } else if (tabIndex === 1) {
            // Nothing to focus
        } else if (tabIndex === 2) {
            dateSelectedEl.focus();
        } else if (tabIndex === 3) {
            nombreInput.focus();
        }
      }, 220);
    }
    
    function checkCurrentTabValid() {
        if (tabIndex === 0 && state.service) return true;
        if (tabIndex === 1 && state.barber) return true;
        if (tabIndex === 2 && state.date && state.time !== null) return true;
        if (tabIndex === 3) {
            // Check form validity before confirming
            const valid = nombreInput.value.trim() && apellidoInput.value.trim() && telefonoInput.value.trim();
            if(valid) {
                 btnConfirmAppointment.disabled = false;
            } else {
                 btnConfirmAppointment.disabled = true;
            }
            return valid;
        }
        return false;
    }


    prevTab.addEventListener('click', () => { 
        if (tabIndex > 0) { 
            tabIndex--; 
            updateTabs(); 
            // Hide message on moving back
            hideMessage(submitMessageEl);
        } 
    });
    
    nextTab.addEventListener('click', () => {
        if (!checkCurrentTabValid()) {
            // Optionally add shake or highlight if required fields are missing
            if(tabIndex === 0) alert('Debes seleccionar un servicio.');
            if(tabIndex === 1) alert('Debes seleccionar un barbero.');
            if(tabIndex === 2) alert('Debes seleccionar una fecha y una hora disponible.');
            if(tabIndex === 3) alert('Por favor, completa todos tus datos (Nombre, Apellido, Teléfono).');
            return;
        }

        if (tabIndex < tabPanes.length - 1) {
            tabIndex++;
            updateTabs();
        } else {
            // Last Tab: Attempt Confirmation
            handleConfirmAppointment();
        }
    });


    // --- EVENT LISTENERS FOR INPUTS ---
    
    dateSelectedEl.addEventListener('change', (e) => {
        // Asegurar que no se seleccione una fecha pasada
        const today = new Date().toISOString().split('T')[0];
        if (e.target.value < today) {
            alert("No puedes seleccionar una fecha pasada.");
            e.target.value = today;
        }
        state.date = e.target.value;
        state.time = null; // Reset time when date changes
        updateTimeSlots();
        updateSummary();
    });

    // Inputs en Tab 4
    nombreInput.addEventListener('input', () => { 
        state.name = nombreInput.value.trim(); 
        updateTabs();
    });
    apellidoInput.addEventListener('input', () => { 
        state.name += ' ' + apellidoInput.value.trim(); 
        updateTabs();
    });
    telefonoInput.addEventListener('input', () => { 
        state.phone = telefonoInput.value.trim(); 
        updateTabs();
    });
    
    // Configurar la fecha mínima a hoy
    dateSelectedEl.min = new Date().toISOString().split('T')[0];


    // --- SUBMISSION LOGIC ---
    async function handleConfirmAppointment() {
        const { service, barber, date, time, name, phone } = state;
        
        if (!service || !barber || !date || time === null || !name || !phone) {
            showMessage(submitMessageEl, 'error', 'Error de validación: Por favor, revisa todos los pasos.');
            return;
        }
        
        btnConfirmAppointment.disabled = true;
        btnConfirmAppointment.innerHTML = 'Agendando... <span class="loader"></span>';

        // Re-check availability right before saving to prevent double-booking or booking on absence
        const isCurrentlyAbsent = checkBarberAbsence(date, time, time + service.duration);
        
        if (isCurrentlyAbsent) {
            showMessage(submitMessageEl, 'error', `¡Error! El barbero ${barber} ya no está disponible a esa hora.`);
            btnConfirmAppointment.disabled = false;
            btnConfirmAppointment.textContent = 'Confirmar Cita';
            // Vuelve al paso 3 para que el cliente seleccione otra hora
            tabIndex = 2;
            updateTabs();
            updateTimeSlots();
            return;
        }

        try {
            // Path: appointments/{barberName}/{dateISO}
            const dateRef = ref(db, `appointments/${barber}/${date}`);
            const newAppointmentRef = push(dateRef); // Genera una clave única
            
            await set(newAppointmentRef, {
                nombre: name,
                telefono: phone,
                servicio: service.name,
                durationMinutes: service.duration,
                startMinutes: time,
                createdAt: Date.now(),
                completed: false // Nuevo campo para tracking
            });

            // Success feedback
            showMessage(submitMessageEl, 'success', '¡Cita agendada con éxito! Revisaremos tu solicitud.');
            
            // Generate WhatsApp link for confirmation
            const waMessage = `¡Hola ${barber}! Soy ${name} y acabo de agendar una cita contigo para el ${date} a las ${minutesToAmPm(time)} para un ${service.name} (${service.duration} min). Mi número es ${phone}.`;
            const waLink = `https://wa.me/${phone}?text=${encodeURIComponent(waMessage)}`;

            // Reset state after successful booking (optional)
            // state = { service: null, barber: null, date: null, time: null, name: '', phone: '' };
            
            // Provide confirmation link
            btnConfirmAppointment.innerHTML = `<a href="${waLink}" target="_blank" style="text-decoration:none; color:white;">Notificar al Barbero por WhatsApp</a>`;
            btnConfirmAppointment.style.background = 'var(--good)';
            
            // Disable navigation
            prevTab.disabled = true;
            nextTab.disabled = true;

        } catch(error) {
            console.error("Error al guardar la cita:", error);
            showMessage(submitMessageEl, 'error', 'Error al guardar la cita. Inténtalo de nuevo.');
            btnConfirmAppointment.disabled = false;
            btnConfirmAppointment.textContent = 'Confirmar Cita';
        }
    }


    // --- INITIALIZATION ---
    renderServices();
    renderBarbers();
    updateTabs();
  </script>
</body>
</html>
