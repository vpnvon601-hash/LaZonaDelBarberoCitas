<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA ZONA DEL BARBERO - Agendamiento</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tipograf铆a: Inter es clara y moderna, se ajusta al estilo minimalista -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos Monocrom谩ticos y Modernos */
        :root {
            --color-primary: #000000;
            --color-secondary: #1f1f1f;
            --color-text-light: #ffffff;
            --color-text-dark: #333333;
            --color-accent: #333333;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Gris muy claro */
        }
        .barber-card {
            background-color: var(--color-text-light);
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        /* Estilo para los botones principales y selectores */
        .btn-primary, .input-style, .select-style {
            transition: all 0.2s;
            border-color: var(--color-accent);
            color: var(--color-text-dark);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            font-weight: 600;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-secondary);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-8">
    
    <div id="app-container" class="barber-card w-full max-w-4xl p-6 sm:p-10 rounded-xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2 tracking-tight">LA ZONA DEL BARBERO</h1>
            <p class="text-lg text-gray-500 font-light">Agenda tu Pr贸xima Cita de Estilo</p>
            <p id="user-id-display" class="text-xs text-gray-400 mt-2">ID de Usuario: Cargando...</p>
        </header>

        <!-- Formulario de Agendamiento -->
        <form id="appointment-form">
            
            <!-- SECCIN 1: Informaci贸n Personal -->
            <section class="mb-8 border-b pb-6 border-gray-200">
                <h2 class="text-2xl font-semibold mb-5 text-gray-700">1. Tu Informaci贸n</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                        <input type="text" id="name" required class="input-style w-full p-3 border rounded-lg focus:ring-1 focus:ring-black">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                        <input type="text" id="lastName" required class="input-style w-full p-3 border rounded-lg focus:ring-1 focus:ring-black">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">N煤mero de Tel茅fono</label>
                        <input type="tel" id="phone" required class="input-style w-full p-3 border rounded-lg focus:ring-1 focus:ring-black" placeholder="Ej: 3001234567">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electr贸nico</label>
                        <input type="email" id="email" required class="input-style w-full p-3 border rounded-lg focus:ring-1 focus:ring-black">
                    </div>
                </div>
            </section>

            <!-- SECCIN 2: Selecci贸n de Servicio y Barbero -->
            <section class="mb-8 border-b pb-6 border-gray-200">
                <h2 class="text-2xl font-semibold mb-5 text-gray-700">2. Servicio y Barbero</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label for="barber" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Barbero</label>
                        <select id="barber" required class="select-style w-full p-3 border rounded-lg appearance-none bg-white focus:ring-1 focus:ring-black">
                            <option value="" disabled selected>Elige un profesional</option>
                        </select>
                    </div>
                    <div>
                        <label for="service" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Servicio</label>
                        <select id="service" required class="select-style w-full p-3 border rounded-lg appearance-none bg-white focus:ring-1 focus:ring-black">
                            <option value="" disabled selected>Elige un servicio</option>
                        </select>
                        <p id="service-info" class="text-xs mt-2 text-gray-500 italic"></p>
                    </div>
                </div>
            </section>
            
            <!-- SECCIN 3: Fecha y Hora -->
            <section class="mb-10">
                <h2 class="text-2xl font-semibold mb-5 text-gray-700">3. Programar Cita</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Programar Fecha</label>
                        <input type="date" id="date" required class="input-style w-full p-3 border rounded-lg focus:ring-1 focus:ring-black">
                    </div>
                    <div>
                        <label for="time" class="block text-sm font-medium text-gray-700 mb-1">Programar Hora</label>
                        <select id="time" required disabled class="select-style w-full p-3 border rounded-lg appearance-none bg-gray-100 focus:ring-1 focus:ring-black">
                            <option value="" disabled selected>Selecciona Barbero, Servicio y Fecha primero</option>
                        </select>
                        <div id="loading-message" class="mt-2 text-sm text-gray-500 hidden">Cargando disponibilidad...</div>
                        <div id="no-slots-message" class="mt-2 text-sm text-red-500 hidden">No hay horas disponibles para la combinaci贸n seleccionada.</div>
                    </div>
                </div>
            </section>

            <!-- Notificaci贸n de Estado -->
            <div id="message-box" class="hidden p-4 rounded-lg text-sm mb-6" role="alert"></div>

            <!-- Bot贸n de Agendamiento -->
            <button type="submit" id="submit-btn" class="btn-primary w-full p-4 rounded-lg text-lg hover:bg-gray-700 transition duration-300">
                Confirmar Cita y Enviar WhatsApp
            </button>
        </form>
    </div>

    <!-- Scripts de Firebase y L贸gica de la Aplicaci贸n -->
    <script type="module">
        // Importaciones de Firebase (URLs CDN v11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro de Firestore a Debug
        setLogLevel('debug');

        // --- CONFIGURACIN Y CONSTANTES ---

        // Configuraci贸n de Firebase (proporcionada en las especificaciones)
        const firebaseConfig = {
            apiKey: "AIzaSyD0XwAGFWJEFs6_bpPLQGSVeVPyTkymk6I",
            authDomain: "shantybarber-b7b8c.firebaseapp.com",
            databaseURL: "https://shantybarber-b7b8c-default-rtdb.firebaseio.com",
            projectId: "shantybarber-b7b8c",
            storageBucket: "shantybarber-b7b8c.firebasestorage.app",
            messagingSenderId: "568694643758",
            appId: "1:56869643758:web:c1bbf8a68f6e9e3d4ad3bf",
            measurementId: "G-JXMJM9Q3X1"
        };
        
        // Variables globales del entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const FIREBASE_COLLECTION_PATH = `/artifacts/${appId}/public/data/appointments`;

        const BARBERS = [
            { id: 'Dylan', name: 'Dylan' },
            { id: 'Ricardo', name: 'Ricardo' },
            { id: 'Juan', name: 'Juan' },
        ];

        // Mapeo de servicios a duraci贸n (en minutos) y precio
        const SERVICES = {
            'Corte': { price: '18.000', duration: 30 },
            'Corte + Ceja': { price: '22.000', duration: 40 },
            'Corte + Ceja + Barba': { price: '25.000', duration: 60 },
            // La duraci贸n de 2.3 horas (130 minutos) se maneja correctamente aqu铆.
            'Corte + Limpieza Facial': { price: '65.000', duration: 130 }, 
        };

        // Horario Operacional (en minutos desde la medianoche)
        const OPENING_TIME = 600; // 10:00 AM (10 * 60)
        const CLOSING_TIME = 1240; // 8:40 PM (20 * 60 + 40)
        const TIME_STEP = 10; // Intervalo de inicio para citas (cada 10 minutos)

        // Estado de la aplicaci贸n
        let db, auth;
        let currentUserId = null;
        let isAuthReady = false;

        // --- MANEJO DE UI Y ESTADO ---

        const elements = {
            barberSelect: document.getElementById('barber'),
            serviceSelect: document.getElementById('service'),
            dateInput: document.getElementById('date'),
            timeSelect: document.getElementById('time'),
            form: document.getElementById('appointment-form'),
            submitBtn: document.getElementById('submit-btn'),
            serviceInfo: document.getElementById('service-info'),
            messageBox: document.getElementById('message-box'),
            userIdDisplay: document.getElementById('user-id-display'),
            loadingMessage: document.getElementById('loading-message'),
            noSlotsMessage: document.getElementById('no-slots-message'),
        };

        function displayMessage(message, type = 'info') {
            elements.messageBox.textContent = message;
            elements.messageBox.className = 'p-4 rounded-lg text-sm mb-6';
            elements.messageBox.classList.remove('hidden');

            if (type === 'success') {
                elements.messageBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                elements.messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                elements.messageBox.classList.add('bg-gray-100', 'text-gray-700');
            }
        }

        function populateSelectors() {
            // Rellenar Barbero
            BARBERS.forEach(barber => {
                const option = document.createElement('option');
                option.value = barber.id;
                option.textContent = barber.name;
                elements.barberSelect.appendChild(option);
            });

            // Rellenar Servicios
            Object.keys(SERVICES).forEach(serviceName => {
                const service = SERVICES[serviceName];
                const option = document.createElement('option');
                option.value = serviceName;
                option.textContent = `${serviceName} ($${service.price} COP, ${service.duration} min)`;
                elements.serviceSelect.appendChild(option);
            });

            // Establecer la fecha m铆nima a hoy
            const today = new Date().toISOString().split('T')[0];
            elements.dateInput.setAttribute('min', today);
        }
        
        // --- UTILIDADES DE TIEMPO ---

        /** Convierte una hora HH:MM a minutos desde la medianoche. */
        function timeToMinutes(time) {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        /** Convierte minutos desde la medianoche a una hora HH:MM. */
        function minutesToTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        
        /** Normaliza una fecha ISO (YYYY-MM-DD) para consistencia. */
        function normalizeDate(dateString) {
             // Esta funci贸n es vital para evitar problemas de zona horaria al comparar fechas
             const date = new Date(dateString);
             // Retorna la fecha en formato YYYY-MM-DD
             return date.toISOString().split('T')[0];
        }


        // --- LGICA DE DISPONIBILIDAD DE HORARIO (CORE) ---

        /** * Calcula y filtra las horas disponibles para un servicio de duraci贸n variable.
         * La l贸gica asegura que:
         * 1. El servicio quepa dentro del horario 10:00 AM (600 min) - 8:40 PM (1240 min).
         * 2. No se solape con citas ya agendadas.
         */
        function getAvailableTimes(barberId, selectedDate, duration, existingAppointments) {
            const availableTimes = [];
            
            // 1. Filtrar citas relevantes para el barbero y la fecha
            const filteredAppointments = existingAppointments.filter(appt => 
                appt.barberId === barberId && normalizeDate(appt.date) === normalizeDate(selectedDate)
            );
            
            // Convertir citas a bloques de tiempo ocupado [startMin, endMin)
            const occupiedSlots = filteredAppointments.map(appt => {
                const startMin = timeToMinutes(appt.time);
                // La duraci贸n guardada de la cita es crucial
                const endMin = startMin + appt.duration; 
                return { start: startMin, end: endMin };
            });

            // 2. Iterar sobre posibles horas de inicio cada 10 minutos
            for (let startMin = OPENING_TIME; startMin < CLOSING_TIME; startMin += TIME_STEP) {
                const endMin = startMin + duration;

                // 3. **VERIFICACIN CRTICA**: Verificar si el servicio cabe antes de la hora de cierre (8:40 PM).
                // Un servicio DEBE finalizar a m谩s tardar a CLOSING_TIME (1240 min).
                if (endMin > CLOSING_TIME) {
                    // Si el servicio termina despu茅s de las 8:40 PM, se detiene la b煤squeda 
                    // ya que las horas siguientes tampoco servir谩n.
                    break;
                }

                let isSlotAvailable = true;

                // 4. Verificar solapamiento con citas existentes (BLOQUEO DINMICO)
                for (const slot of occupiedSlots) {
                    // Criterio de Solapamiento para intervalos [a, b) y [c, d): a < d && c < b
                    // Nuevo Servicio: [startMin, endMin)
                    // Cita Existente: [slot.start, slot.end)
                    if (startMin < slot.end && endMin > slot.start) {
                        isSlotAvailable = false;
                        break;
                    }
                }

                if (isSlotAvailable) {
                    availableTimes.push(minutesToTime(startMin));
                }
            }

            return availableTimes;
        }


        // --- MANEJO DE DATOS Y EVENTOS ---

        async function fetchAppointmentsAndRefreshTimes() {
            if (!isAuthReady || !db) return;

            // Mostrar estado de carga
            elements.timeSelect.innerHTML = '<option value="" disabled selected>Cargando disponibilidad...</option>';
            elements.timeSelect.disabled = true;
            elements.loadingMessage.classList.remove('hidden');
            elements.noSlotsMessage.classList.add('hidden');

            const barberId = elements.barberSelect.value;
            const serviceName = elements.serviceSelect.value;
            const date = elements.dateInput.value;

            if (!barberId || !serviceName || !date) {
                elements.timeSelect.innerHTML = '<option value="" disabled selected>Selecciona Barbero, Servicio y Fecha primero</option>';
                elements.timeSelect.disabled = true;
                elements.loadingMessage.classList.add('hidden');
                return;
            }

            const duration = SERVICES[serviceName].duration;
            
            try {
                // Obtener citas solo para la fecha seleccionada para optimizar la consulta
                const collectionRef = collection(db, FIREBASE_COLLECTION_PATH);
                const q = query(collectionRef, where('date', '==', normalizeDate(date)));
                const snapshot = await getDocs(q);
                
                // Mapear los documentos a un formato de cita simple
                const appointmentsOnDate = snapshot.docs.map(doc => doc.data());

                const availableTimes = getAvailableTimes(barberId, date, duration, appointmentsOnDate);
                
                // Rellenar el selector de hora
                elements.timeSelect.innerHTML = '';
                if (availableTimes.length > 0) {
                    elements.timeSelect.disabled = false;
                    elements.timeSelect.innerHTML = '<option value="" disabled selected>Elige una hora</option>';
                    availableTimes.forEach(time => {
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        elements.timeSelect.appendChild(option);
                    });
                } else {
                    elements.timeSelect.innerHTML = '<option value="" disabled selected>Sin horarios disponibles</option>';
                    elements.timeSelect.disabled = true;
                    elements.noSlotsMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error al calcular o cargar citas:", error);
                displayMessage("Error al cargar la disponibilidad. Intenta de nuevo.", 'error');
            } finally {
                elements.loadingMessage.classList.add('hidden');
            }
        }
        
        /** Maneja los cambios en los selectores para actualizar la disponibilidad. */
        function handleSelectionChange() {
            const serviceName = elements.serviceSelect.value;
            
            // Mostrar informaci贸n del servicio
            if (serviceName) {
                const service = SERVICES[serviceName];
                elements.serviceInfo.textContent = `Duraci贸n: ${service.duration} minutos | Precio: $${service.price} COP.`;
            } else {
                elements.serviceInfo.textContent = '';
            }
            
            // Forzar rec谩lculo si todos los campos est谩n llenos
            const barberId = elements.barberSelect.value;
            const date = elements.dateInput.value;
            if (barberId && serviceName && date) {
                fetchAppointmentsAndRefreshTimes();
            } else {
                 elements.timeSelect.innerHTML = '<option value="" disabled selected>Selecciona Barbero, Servicio y Fecha primero</option>';
                 elements.timeSelect.disabled = true;
                 elements.loadingMessage.classList.add('hidden');
                 elements.noSlotsMessage.classList.add('hidden');
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            elements.submitBtn.disabled = true;
            elements.submitBtn.textContent = 'Agendando...';
            elements.messageBox.classList.add('hidden');

            const serviceName = elements.serviceSelect.value;
            const duration = SERVICES[serviceName].duration;
            const price = SERVICES[serviceName].price;

            const appointmentData = {
                // Informaci贸n Personal
                name: document.getElementById('name').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),

                // Informaci贸n de la Cita
                barberId: elements.barberSelect.value,
                serviceName: serviceName,
                date: normalizeDate(elements.dateInput.value), // Fecha normalizada (YYYY-MM-DD)
                time: elements.timeSelect.value, // Hora de inicio (HH:MM)
                duration: duration,
                price: price,
                
                // Metadata
                bookedAt: new Date().toISOString(),
                userId: currentUserId,
            };

            try {
                // 1. Re-verificar la disponibilidad justo antes de guardar (protecci贸n contra concurrencia)
                const collectionRef = collection(db, FIREBASE_COLLECTION_PATH);
                const q = query(collectionRef, where('date', '==', appointmentData.date));
                const snapshot = await getDocs(q);
                const appointmentsOnDate = snapshot.docs.map(doc => doc.data());
                
                const availableTimes = getAvailableTimes(appointmentData.barberId, appointmentData.date, appointmentData.duration, appointmentsOnDate);
                
                if (!availableTimes.includes(appointmentData.time)) {
                     displayMessage("El horario seleccionado ya no est谩 disponible. Por favor, selecciona otra hora.", 'error');
                     elements.submitBtn.disabled = false;
                     elements.submitBtn.textContent = 'Confirmar Cita y Enviar WhatsApp';
                     // Recalcular y actualizar la lista de horas
                     fetchAppointmentsAndRefreshTimes(); 
                     return;
                }
                
                // 2. Guardar en Firestore
                await addDoc(collection(db, FIREBASE_COLLECTION_PATH), appointmentData);
                
                displayMessage("Cita agendada con 茅xito. Redirigiendo a WhatsApp para confirmaci贸n...", 'success');
                
                // 3. Generar y Redirigir a WhatsApp
                const fullDateTime = `${appointmentData.date} a las ${appointmentData.time}`;
                const waMessage = 
                    `隆Hola! Acabo de agendar una cita en LA ZONA DEL BARBERO.\n\n` +
                    `Detalles de la Cita:\n` +
                    ` Cliente: ${appointmentData.name} ${appointmentData.lastName}\n` +
                    ` Barbero: ${appointmentData.barberId}\n` +
                    `锔 Servicio: ${appointmentData.serviceName} ($${appointmentData.price} COP)\n` +
                    ` Fecha y Hora: ${fullDateTime}\n` +
                    ` Contacto: ${appointmentData.phone}\n\n` +
                    `隆Gracias!`;
                    
                const waApiUrl = `https://api.whatsapp.com/send?phone=573233489369&text=${encodeURIComponent(waMessage)}`;
                
                // Abrir en nueva pesta帽a
                window.open(waApiUrl, '_blank');
                
                // 4. Limpiar formulario
                elements.form.reset();
                handleSelectionChange(); // Restablecer selectores de hora
                
            } catch (error) {
                console.error("Error al guardar la cita:", error);
                displayMessage(`Error al agendar la cita: ${error.message}. Por favor, int茅ntalo de nuevo.`, 'error');
            } finally {
                elements.submitBtn.disabled = false;
                elements.submitBtn.textContent = 'Confirmar Cita y Enviar WhatsApp';
            }
        }


        // --- INICIALIZACIN DE FIREBASE ---
        
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Autenticaci贸n
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Listener de estado de autenticaci贸n
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        elements.userIdDisplay.textContent = `ID de Usuario: ${currentUserId}`;
                        isAuthReady = true;
                        // Forzar el rec谩lculo inicial una vez que la autenticaci贸n est茅 lista
                        handleSelectionChange();
                    } else {
                        currentUserId = crypto.randomUUID(); 
                        elements.userIdDisplay.textContent = `ID de Usuario (An贸nimo): ${currentUserId.substring(0, 8)}...`;
                        isAuthReady = true;
                        handleSelectionChange();
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                displayMessage("Error fatal de conexi贸n con la base de datos.", 'error');
            }
        }
        
        // --- INICIO DE LA APLICACIN ---
        window.onload = () => {
            populateSelectors();
            initFirebase();
            
            // A帽adir Listeners de Eventos
            elements.barberSelect.addEventListener('change', handleSelectionChange);
            elements.serviceSelect.addEventListener('change', handleSelectionChange);
            elements.dateInput.addEventListener('change', handleSelectionChange);
            elements.form.addEventListener('submit', handleFormSubmit);

            // La llamada a handleSelectionChange() inicial se hace dentro de onAuthStateChanged
        };

    </script>
</body>
</html>

