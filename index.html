<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LA ZONA DEL BARBERO — Agenda tu Cita</title>
    <style>
        /* (Asume que los estilos CSS son los mismos que en el panel, o los tienes ya definidos. No los incluyo por espacio, pero asegúrate de tener la sección <style>.) */
        :root{
            --bg:#06070a; --card:#0e1115; --muted:#9aa0a6; --line:#1e252b;
            --text:#e6eef3; --accent:#f6c358; --accent-2:#7be3a8; --glass:rgba(255,255,255,0.03);
            --danger:#ef6b6b; --good:#35d19b;
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#030304 0%,#071018 100%);color:var(--text);-webkit-font-smoothing:antialiased; padding:20px;}
        .container{max-width:900px;margin:auto;}
        .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:var(--radius);border:1px solid var(--line);box-shadow:0 6px 30px rgba(0,0,0,0.6); margin-bottom: 20px;}
        h2{color:var(--accent); text-align:center;}
        h3{margin:0 0 12px 0;font-weight:700}
        label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px; margin-top: 10px;}
        input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text);font-size:15px}
        button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071018;border:none;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:0 8px 20px rgba(123,227,168,0.06); width: 100%; margin-top: 20px;}
        .row{display:flex;gap:10px;}
        .message{padding:10px;border-radius:10px;margin-top:10px;font-size:14px; display:none; margin-bottom: 10px;} 
        .success{background:rgba(53, 209, 155, 0.1); color:var(--good); border:1px solid var(--good);}
        .error{background:rgba(239, 107, 107, 0.1); color:var(--danger); border:1px solid var(--danger);}
        .loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid var(--line);border-top-color:var(--accent);animation:spin .9s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Estilos específicos de agendamiento */
        .barber-photo-container{width:60px; height:60px; border-radius:50%; overflow:hidden; border:2px solid var(--accent); margin-right:10px; flex-shrink:0;}
        .barber-photo-container img{width:100%; height:100%; object-fit:cover;}
        .barber-info{display:flex; align-items:center; margin-bottom:15px;}
        
        .slots-grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap:10px; margin-top:15px; padding: 10px; border: 1px solid var(--line); border-radius: 10px; max-height: 250px; overflow-y: auto;}
        .slot{padding:10px; border-radius:8px; text-align:center; font-weight:700; cursor:pointer; background:rgba(255,255,255,0.05); border:1px solid transparent; transition: all 0.2s;}
        .slot.selected{background:var(--accent); color:var(--bg); border-color:var(--accent-2);}
        .slot.busy{background:var(--danger); color:white; opacity:0.6; cursor:default; font-weight:400; font-size:12px; height: auto;}
        .slot:not(.busy):hover{border-color:var(--accent);}
        .summary-item{margin-bottom:8px;}
        .summary-item strong{color:var(--accent-2);}
        .small{font-size:12px; color:var(--muted);}
    </style>
</head>
<body>
    <div class="container">
        <h2 style="margin-bottom: 20px; margin-top: 10px;">Agenda tu Cita — LA ZONA DEL BARBERO</h2>
        
        <div id="bookingContainer" class="card">
            <h3>Paso 1: Servicio y Barbero</h3>
            
            <label for="servicio">Servicio a Agendar</label>
            <select id="servicio">
                <option value="">Selecciona un servicio...</option>
                <option value="Corte Hombre Clásico" data-duration="45">Corte Hombre Clásico (45 min)</option>
                <option value="Diseño de Barba" data-duration="30">Diseño de Barba (30 min)</option>
                <option value="Corte + Barba" data-duration="75">Corte + Barba (75 min)</option>
                <option value="Diseño de Cejas" data-duration="15">Diseño de Cejas (15 min)</option>
            </select>

            <label for="barbero">Barbero Preferido</label>
            <select id="barbero">
                <option value="">Cualquiera</option>
                <option value="Dilan">Dilan</option>
                <option value="Alejandro">Alejandro</option>
                <option value="Leonardo">Leonardo</option>
                <option value="Santiago">Santiago</option>
            </select>
            
            <div id="barberPhotoContainer" class="barber-info" style="margin-top:20px;">
                <div class="barber-photo-container"><img id="barberPhoto" src="default.png" alt="Barbero"></div>
                <span id="barberNameSummary" style="font-weight:700;">Barbero: Cualquiera</span>
            </div>

            <div class="row">
                <div style="flex:1;">
                    <label for="fecha">Fecha de la Cita</label>
                    <input id="fecha" type="date">
                </div>
                <div style="flex:1;">
                    <label for="horaSelect">Hora (Opción Rápida)</label>
                    <select id="horaSelect">
                        <option value="">Selecciona hora...</option>
                    </select>
                </div>
            </div>
            
            <div id="availabilityList" style="margin-top:15px; font-weight:700;">Selecciona barbero y fecha.</div>
            <div id="slotsBox" class="slots-grid">Sin datos.</div>
            
            <h3 style="margin-top:20px;">Paso 2: Tus Datos</h3>

            <label for="nombre">Tu Nombre Completo</label>
            <input id="nombre" type="text" placeholder="Ej: Juan Pérez">

            <label for="telefono">Número de WhatsApp (Ej: 3001234567)</label>
            <input id="telefono" type="tel" placeholder="Sin espacios ni guiones (Solo números)">

            <label for="notas">Notas Adicionales (Opcional)</label>
            <input id="notas" type="text" placeholder="Alguna indicación especial">

            <h3 style="margin-top:20px;">Paso 3: Confirmación</h3>
            <div class="card" style="padding:15px; background: rgba(123, 227, 168, 0.05);">
                <div class="summary-item">Servicio: <strong id="summaryService">-</strong></div>
                <div class="summary-item">Duración: <strong id="summaryDuration">-</strong></div>
                <div class="summary-item">Precio: <strong id="summaryPrice">-</strong></div>
                <div class="summary-item">Barbero: <strong id="summaryBarber">-</strong></div>
                <div class="summary-item">Fecha y Hora: <strong id="summaryDateTime">-</strong></div>
            </div>
            
            <div id="bookingMessage" class="message"></div>

            <button class="primary" id="btnGuardar">CONFIRMAR RESERVA</button>
            <p style="text-align:center; font-size:12px; color:var(--muted); margin-top:15px;">Al confirmar, aceptas nuestras políticas de reserva.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIGURACIÓN DE HORARIOS (Mantener en un solo lugar)
        const OPEN_MIN = 8 * 60; // 8:00 AM
        const CLOSE_MIN = 20 * 60; // 8:00 PM
        const INTERVAL_MIN = 15; // Slots cada 15 minutos

        // Firebase config (Misma que en el Panel Admin)
        const firebaseConfig = {
          apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
          authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
          databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
          projectId: "lazonadelbarbero-b4e75",
          storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
          messagingSenderId: "251180096928",
          appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
          measurementId: "G-G4YL7M4Z00"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Fotos de Barbero (Ajusta las rutas a tus fotos)
        const BARBER_PHOTOS = {
            "Dilan": "dilan.png",
            "Alejandro": "alejo.png",
            "Leonardo": "leo.png",
            "Santiago": "santi.png",
            "Cualquiera": "default.png"
        };

        // DOM Elements
        const servicioEl = document.getElementById('servicio');
        const barberoEl = document.getElementById('barbero');
        const fechaEl = document.getElementById('fecha');
        const horaSelect = document.getElementById('horaSelect');
        const nombreEl = document.getElementById('nombre');
        const telefonoEl = document.getElementById('telefono');
        const notasEl = document.getElementById('notas');
        const btnGuardar = document.getElementById('btnGuardar');
        const bookingMessageEl = document.getElementById('bookingMessage');
        const slotsBox = document.getElementById('slotsBox');
        const availableList = document.getElementById('availabilityList');

        // Summary DOM
        const summaryService = document.getElementById('summaryService');
        const summaryDuration = document.getElementById('summaryDuration');
        const summaryPrice = document.getElementById('summaryPrice');
        const summaryBarber = document.getElementById('summaryBarber');
        const summaryDateTime = document.getElementById('summaryDateTime');
        const barberPhoto = document.getElementById('barberPhoto');
        const barberNameSummary = document.getElementById('barberNameSummary');

        // --- UTILS ---
        function minutesToShortAmPm(m){
            let hh = Math.floor(m/60); const mm = String(m%60).padStart(2,'0');
            const ampm = hh >= 12 ? 'pm' : 'am'; hh = hh % 12; if(hh===0) hh=12;
            return `${hh}:${mm}${ampm}`;
        }
        function parseDuration(){
            const selectedOption = servicioEl.options[servicioEl.selectedIndex];
            return selectedOption.dataset.duration ? parseInt(selectedOption.dataset.duration) : null;
        }
        function generateCandidateStarts(duration){
            const candidates = [];
            // Empezar en la primera hora completa que permite terminar antes de la hora de cierre
            for(let m = OPEN_MIN; m <= CLOSE_MIN - duration; m += INTERVAL_MIN){
                candidates.push(m);
            }
            return candidates;
        }
        
        function buildOccupied(appointments){
            return appointments.map(appt => ({
                start: appt.startMinutes,
                end: appt.endMinutes,
                reason: appt.reason // Si viene de ausencia, traerá razón
            }));
        }

        function isConflict(start, end, occupiedSlots){
            return occupiedSlots.some(slot => 
                // Condición de solapamiento: [start, end] se solapa con [slot.start, slot.end]
                start < slot.end && end > slot.start
            );
        }
        
        function showMessage(type, text) {
            bookingMessageEl.classList.remove('success', 'error');
            bookingMessageEl.classList.add(type);
            bookingMessageEl.textContent = text;
            bookingMessageEl.style.display = 'block';
            setTimeout(() => { bookingMessageEl.style.display = 'none'; }, 6000);
        }

        function updateBarberoPhoto(barbero) {
            const photoSrc = BARBER_PHOTOS[barbero] || BARBER_PHOTOS['Cualquiera'];
            barberPhoto.src = photoSrc;
            barberNameSummary.textContent = `Barbero: ${barbero}`;
            summaryBarber.textContent = barbero;
        }

        // --- FIREBASE READ LOGIC ---

        // Función para traer todas las citas de un barbero en una fecha
        async function fetchAppointmentsRT(barbero, dateVal) {
            const path = `appointments/${barbero}/${dateVal}`;
            const snapshot = await get(child(ref(db), path));
            if (!snapshot.exists()) return [];
            
            const data = snapshot.val();
            const appointments = [];
            for(const key in data){
                const appt = data[key];
                appt.id = key;
                appt.startMinutes = Number(appt.startMinutes);
                appt.endMinutes = Number(appt.endMinutes || (appt.startMinutes + appt.durationMinutes));
                appointments.push(appt);
            }
            return appointments;
        }
        
        // *****************************************************************
        // *** NUEVO: FUNCIÓN PARA TRAER AUSENCIAS DE LA NUEVA RUTA ***
        // *****************************************************************
        async function fetchAbsencesRT(barbero, dateVal) {
            if(!barbero || !dateVal) return null;
            
            const absencesRef = ref(db, `unavailableDates/${barbero}`); 
            const snapshot = await get(absencesRef);
            if (!snapshot.exists()) return null;

            const data = snapshot.val();
            
            // 1. CHEQUEO DE AUSENCIA DE DÍA COMPLETO (revisa rangos guardados en /days)
            const dayAbsences = data.days || {};
            let isFullDay = false;
            let fullDayReason = null;
            
            for (const startDate in dayAbsences) {
                const period = dayAbsences[startDate];
                // Revisa si la fecha solicitada (dateVal) cae entre startDate y endDate
                if (dateVal >= startDate && dateVal <= period.endDate) {
                isFullDay = true;
                fullDayReason = period.reason;
                break;
                }
            }

            if (isFullDay) {
                return { isFullDay: true, reason: fullDayReason, intervals: [] };
            }

            // 2. CHEQUEO DE AUSENCIA POR HORAS (revisa los bloques guardados en /hours)
            const hourlyAbsencesOnDate = data.hours ? data.hours[dateVal] : null;
            const intervals = [];

            if (hourlyAbsencesOnDate) {
                // Convierte el objeto de horas (clave=startMinutes) en un array
                for (const startMinKey in hourlyAbsencesOnDate) {
                const period = hourlyAbsencesOnDate[startMinKey];
                intervals.push({
                    start: Number(startMinKey), 
                    end: Number(period.endMinutes), 
                    reason: period.reason
                });
                }
            }

            return { isFullDay: false, reason: null, intervals: intervals };
        }
        // *****************************************************************


        // --- MAIN AVAILABILITY LOGIC (MODIFICADO) ---
        
        // Escucha cambios en los campos clave para refrescar la disponibilidad
        servicioEl.addEventListener('change', refreshAvailability);
        barberoEl.addEventListener('change', refreshAvailability);
        fechaEl.addEventListener('change', refreshAvailability);
        horaSelect.addEventListener('change', updateSummary);
        
        function updateSummary() {
            const duration = parseDuration();
            const startMinutes = horaSelect.value;
            const horaNice = startMinutes ? minutesToShortAmPm(Number(startMinutes)) : '---';
            
            summaryDateTime.textContent = `${fechaEl.value || 'Fecha'} a las ${horaNice}`;
        }


        // ***************************************************************
        // ** MODIFICADO: refreshAvailability con manejo de Ausencias y Horas Pasadas **
        // ***************************************************************
        async function refreshAvailability(){
            const service = servicioEl.value;
            const duration = parseDuration();
            summaryService.textContent = service || '-';
            summaryDuration.textContent = duration ? `${duration} min` : '-';
            summaryPrice.textContent = 'Consultar con barbero'; 

            const barbero = barberoEl.value;
            const dateVal = fechaEl.value;
            
            updateBarberoPhoto(barbero);

            availableList.innerHTML = '';
            slotsBox.innerHTML = '';
            horaSelect.innerHTML = '<option value="">Selecciona hora...</option>';
            summaryDateTime.textContent = '---';

            if(!service || !duration){
                availableList.innerHTML = 'Selecciona un servicio y duración.';
                slotsBox.textContent = 'Sin datos.';
                return;
            }

            const candidates = generateCandidateStarts(duration);

            if(!barbero || !dateVal){
                availableList.innerHTML = 'Selecciona barbero y fecha para disponibilidad real.';
                slotsBox.textContent = 'Selecciona barbero y fecha.';
                return;
            }

            availableList.innerHTML = '<div class="small">Cargando disponibilidad... <span class="loader"></span></div>';
            try{
                const [appts, absenceData] = await Promise.all([
                    fetchAppointmentsRT(barbero, dateVal),
                    fetchAbsencesRT(barbero, dateVal) // <--- USA LA FUNCIÓN ACTUALIZADA
                ]);

                // --- CALCULAR HORA ACTUAL ---
                const todayISO = new Date().toISOString().split('T')[0];
                const now = new Date();
                // Minutos desde medianoche
                const currentMinutes = now.getHours() * 60 + now.getMinutes();

                // --- MANEJO DE AUSENCIA COMPLETA ---
                if(absenceData && absenceData.isFullDay){
                    availableList.innerHTML = `❌ ${barbero} no está disponible el ${dateVal}.`;
                    slotsBox.innerHTML = `<div class="slot busy" style="opacity:1;">**Ausente (Día Completo):** ${absenceData.reason || 'No disponible por día completo'}</div>`;
                    horaSelect.innerHTML = '<option value="">Barbero ausente</option>';
                    return;
                }

                let occupied = buildOccupied(appts);
                
                // --- AÑADIR INTERVALOS DE AUSENCIA POR HORA A OCUPADOS ---
                if(absenceData && absenceData.intervals.length > 0){
                    const absenceIntervals = absenceData.intervals.map(i => ({
                        start: i.start, 
                        end: i.end, 
                        reason: i.reason || 'Ausencia temporal'
                    }));
                    // Aseguramos que los intervalos de ausencia también se consideren ocupados
                    occupied = buildOccupied([...occupied, ...absenceIntervals]);
                    availableList.innerHTML = `<div class="small" style="color:var(--danger)">(${barbero} tiene bloques de **ausencia temporal** hoy)</div>`;
                } else {
                    availableList.innerHTML = `Disponibilidad para ${barbero} el ${dateVal}:`;
                }

                let anyAvailable = false;
                
                for(const s of candidates){
                    const e = s + duration;
                    if(e > CLOSE_MIN) continue;

                    const div = document.createElement('div');
                    div.className = 'slot';
                    
                    let conflictReason = null;
                    
                    // 1. **VERIFICAR HORA PASADA**
                    const isPastTime = dateVal === todayISO && s < currentMinutes;

                    if(isPastTime) {
                        conflictReason = 'Hora ya pasada';
                    } 
                    // 2. Verificar conflicto con citas o ausencias (ocupados)
                    else if(isConflict(s, e, occupied)){
                        const isDueToAppointment = isConflict(s,e, buildOccupied(appts));
                        
                        if(isDueToAppointment) {
                            conflictReason = 'Hora ya agendada';
                        } else if (absenceData && absenceData.intervals.length > 0) {
                            const conflictInterval = absenceData.intervals.find(iv => s < iv.end && e > iv.start);
                            if(conflictInterval) {
                                conflictReason = conflictInterval.reason || 'Bloqueo (Ausencia)';
                            } else {
                                conflictReason = 'No disponible';
                            }
                        } else {
                            conflictReason = 'No disponible';
                        }
                    }

                    if(conflictReason){
                        div.classList.add('busy');
                        div.textContent = `${minutesToShortAmPm(s)} — ${conflictReason}`;
                        slotsBox.appendChild(div);
                        continue;
                    }

                    // Si llega aquí, está disponible
                    anyAvailable = true;
                    div.textContent = `${minutesToShortAmPm(s)}`;
                    div.onclick = () => {
                        horaSelect.value = s;
                        updateSummary();
                        document.querySelectorAll('.slot').forEach(x=>{ x.classList.remove('selected'); x.style.background=''; x.style.color=''; });
                        div.classList.add('selected');
                    };
                    slotsBox.appendChild(div);
                    const opt = document.createElement('option'); opt.value = s; opt.textContent = minutesToShortAmPm(s); horaSelect.appendChild(opt);
                }

                if(!anyAvailable){
                    slotsBox.innerHTML = '<div class="small">No hay horas libres para este servicio en esta fecha.</div>';
                    horaSelect.innerHTML = '<option value="">No disponible</option>';
                }

            } catch(err){
                console.error(err);
                availableList.innerHTML = 'Error cargando disponibilidad.';
                slotsBox.textContent = '-';
                horaSelect.innerHTML = '<option value="">Error</option>';
            }
        }


        // --- SAVE LOGIC ---

        btnGuardar.addEventListener('click', async () => {
            const barbero = barberoEl.value;
            const dateVal = fechaEl.value;
            const startMinutes = horaSelect.value;
            const nombre = nombreEl.value.trim();
            const telefono = telefonoEl.value.trim().replace(/\D/g, ''); // Limpiar el teléfono
            const servicio = servicioEl.value;
            const duration = parseDuration();
            const notas = notasEl.value.trim();
            
            if (!barbero || !dateVal || !startMinutes || !nombre || telefono.length < 10 || !servicio || !duration) {
                showMessage('error', 'Por favor, completa todos los campos requeridos y selecciona una hora válida. El teléfono debe tener al menos 10 dígitos.');
                return;
            }

            btnGuardar.disabled = true;
            btnGuardar.innerHTML = 'Guardando cita... <span class="loader"></span>';

            try{
                // ** DOBLE CHEQUEO DE DISPONIBILIDAD EN TIEMPO REAL **
                const [appts, absenceData] = await Promise.all([
                    fetchAppointmentsRT(barbero, dateVal),
                    fetchAbsencesRT(barbero, dateVal) // <-- Usa la nueva lógica
                ]);

                const start = Number(startMinutes);
                const end = start + duration;

                let occupied = buildOccupied(appts);
                
                // Añadir intervalos de ausencia a los ocupados para el chequeo
                if(absenceData && absenceData.intervals.length > 0) {
                    const absenceIntervals = absenceData.intervals.map(i => ({
                        start: i.start, 
                        end: i.end, 
                        reason: i.reason
                    }));
                    occupied = buildOccupied([...occupied, ...absenceIntervals]);
                }

                if (isConflict(start, end, occupied)) {
                    showMessage('error', '¡Error! La hora seleccionada ya no está disponible. Por favor, refresca y selecciona otro slot.');
                    return;
                }
                
                // Chequeo final de hora pasada
                const todayISO = new Date().toISOString().split('T')[0];
                const nowMinutes = new Date().getHours() * 60 + new Date().getMinutes();
                if (dateVal === todayISO && start < nowMinutes) {
                    showMessage('error', '¡Error! No se puede agendar una cita en el pasado.');
                    return;
                }

                // Generar ID único usando push para que no sobrescriba
                const newAppointmentRef = push(ref(db, `appointments/${barbero}/${dateVal}`));
                
                const appointmentData = {
                    barbero: barbero,
                    startMinutes: start,
                    endMinutes: end,
                    durationMinutes: duration,
                    nombre: nombre,
                    telefono: telefono,
                    servicio: servicio,
                    notas: notas,
                    createdAt: Date.now(),
                    completed: false // Nuevo campo por defecto
                };

                await set(newAppointmentRef, appointmentData);

                showMessage('success', `¡Cita confirmada con ${barbero}! Te esperamos el ${dateVal} a las ${minutesToShortAmPm(start)}. Recibirás un WhatsApp de confirmación.`);

                // Limpiar formulario (opcional)
                // location.reload();

            } catch(error) {
                console.error("Error al guardar la cita:", error);
                showMessage('error', 'Hubo un error al guardar tu cita. Inténtalo de nuevo.');
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.textContent = 'CONFIRMAR RESERVA';
            }
        });

        // Inicialización de la fecha mínima
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            fechaEl.setAttribute('min', today);
            updateBarberoPhoto('Cualquiera');
        });

    </script>
</body>
</html>
